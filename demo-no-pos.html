<!DOCTYPE html>
<html lang="ar" dir="rtl" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مُحاسِب - تجربة الفوترة الإلكترونية | E-Invoicing Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* Base Styles from main site */
        .icon { display: inline-flex; align-items: center; justify-content: center; vertical-align: middle; }
        .icon svg { width: 1em; height: 1em; stroke-width: 2; }
        .icon-sm svg { width: 0.875em; height: 0.875em; }
        .icon-lg svg { width: 1.25em; height: 1.25em; }
        .icon-xl svg { width: 2em; height: 2em; }
        .icon-2xl svg { width: 2.5em; height: 2.5em; }
        .icon-3xl svg { width: 3rem; height: 3rem; }
        .icon-4xl svg { width: 4rem; height: 4rem; }
        .icon-emerald { color: #34d399; }
        .icon-purple { color: #a78bfa; }
        .icon-cyan { color: #22d3d1; }
        .icon-white { color: #fff; }
        .icon-amber { color: #fbbf24; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Tajawal', sans-serif; background: #020617; color: #fff; line-height: 1.6; min-height: 100vh; }
        [dir="ltr"] body { font-family: 'Inter', sans-serif; }
        a { text-decoration: none; color: inherit; }
        
        /* Header */
        header { position: fixed; top: 0; width: 100%; background: rgba(2,6,23,0.9); backdrop-filter: blur(8px); z-index: 50; border-bottom: 1px solid #1e293b; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; max-width: 1400px; margin: 0 auto; }
        .logo { display: flex; align-items: center; gap: 0.5rem; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, #a78bfa, #818cf8); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #020617; font-size: 1.25rem; }
        .logo-text { font-size: 1.25rem; font-weight: bold; }
        .header-actions { display: flex; align-items: center; gap: 1rem; }
        .lang-toggle { display: flex; background: #1e293b; border-radius: 8px; padding: 4px; }
        .lang-btn { padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; border: none; cursor: pointer; transition: all 0.3s; background: transparent; color: #94a3b8; }
        .lang-btn.active { background: #a78bfa; color: #fff; }
        .back-btn { display: flex; align-items: center; gap: 0.5rem; color: #94a3b8; font-size: 0.875rem; transition: color 0.3s; }
        .back-btn:hover { color: #fff; }
        
        /* Main Container */
        .demo-container { padding: 7rem 2rem 3rem; max-width: 1400px; margin: 0 auto; }
        
        /* Page Header */
        .page-header { text-align: center; margin-bottom: 2rem; }
        .page-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(167,139,250,0.15); border: 1px solid rgba(167,139,250,0.3); border-radius: 50px; padding: 0.5rem 1.25rem; color: #a78bfa; font-size: 0.875rem; margin-bottom: 1rem; }
        .page-title { font-size: 2rem; font-weight: 800; margin-bottom: 0.75rem; }
        @media(min-width:768px) { .page-title { font-size: 2.5rem; } }
        .gradient-text { background: linear-gradient(to left, #a78bfa, #818cf8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .page-subtitle { color: #94a3b8; font-size: 1rem; max-width: 600px; margin: 0 auto; }
        
        /* Demo Flow Container */
        .demo-flow { display: grid; grid-template-columns: 1fr auto 1fr auto 1fr; align-items: stretch; gap: 1rem; margin-top: 2rem; }
        @media(max-width: 1024px) { 
            .demo-flow { grid-template-columns: 1fr; gap: 1.5rem; }
            .flow-arrow { display: none; }
        }
        
        /* Flow Arrows */
        .flow-arrow { display: flex; align-items: center; justify-content: center; padding: 0 0.5rem; }
        .flow-arrow svg { width: 2rem; height: 2rem; color: #475569; transition: color 0.3s; }
        .flow-arrow.active svg { color: #a78bfa; }
        [dir="ltr"] .flow-arrow { transform: scaleX(-1); }
        
        /* Demo Cards */
        .demo-card { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.9)); border-radius: 20px; border: 1px solid #1e293b; overflow: hidden; display: flex; flex-direction: column; min-height: 450px; transition: all 0.3s; }
        .demo-card.active { border-color: rgba(167,139,250,0.5); box-shadow: 0 0 40px rgba(167,139,250,0.15); }
        .demo-card.completed { border-color: rgba(52,211,153,0.5); }
        
        .card-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 1rem; }
        .card-icon-wrapper { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .card-icon-wrapper.business { background: linear-gradient(135deg, rgba(167,139,250,0.2), rgba(129,140,248,0.2)); }
        .card-icon-wrapper.ai { background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(34,211,209,0.2)); }
        .card-icon-wrapper.zatca { background: linear-gradient(135deg, rgba(251,191,36,0.2), rgba(245,158,11,0.2)); }
        .card-title { font-size: 1rem; font-weight: 700; margin-bottom: 0.25rem; }
        .card-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        .card-status { margin-right: auto; margin-left: 0; }
        [dir="ltr"] .card-status { margin-left: auto; margin-right: 0; }
        
        .status-badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; }
        .status-badge.waiting { background: rgba(100,116,139,0.2); color: #94a3b8; }
        .status-badge.processing { background: rgba(167,139,250,0.2); color: #a78bfa; }
        .status-badge.success { background: rgba(52,211,153,0.2); color: #34d399; }
        .status-badge.error { background: rgba(248,113,113,0.2); color: #f87171; }
        
        .card-content { flex: 1; padding: 1.5rem; display: flex; flex-direction: column; }
        
        /* Upload Zone */
        .upload-zone { flex: 1; border: 2px dashed #334155; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; cursor: pointer; transition: all 0.3s; text-align: center; }
        .upload-zone:hover { border-color: #a78bfa; background: rgba(167,139,250,0.05); }
        .upload-zone.drag-over { border-color: #a78bfa; background: rgba(167,139,250,0.1); }
        .upload-zone.has-file { border-style: solid; border-color: #34d399; background: rgba(52,211,153,0.05); cursor: default; }
        .upload-icon { font-size: 3rem; margin-bottom: 1rem; color: #64748b; }
        .upload-zone.has-file .upload-icon { color: #34d399; }
        .upload-text { font-size: 0.9rem; color: #94a3b8; margin-bottom: 0.5rem; }
        .upload-hint { font-size: 0.75rem; color: #64748b; }
        .upload-input { display: none; }
        
        /* File Preview */
        .file-preview { display: none; flex: 1; flex-direction: column; }
        .file-preview.show { display: flex; }
        .file-info { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: rgba(51,65,85,0.3); border-radius: 12px; margin-bottom: 1rem; }
        .file-icon { width: 48px; height: 48px; background: rgba(167,139,250,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .file-name { font-size: 0.875rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-size { font-size: 0.75rem; color: #64748b; }
        .file-remove { margin-right: auto; margin-left: 0; background: none; border: none; color: #64748b; cursor: pointer; padding: 0.5rem; transition: color 0.3s; }
        [dir="ltr"] .file-remove { margin-left: auto; margin-right: 0; }
        .file-remove:hover { color: #f87171; }
        
        .invoice-preview { flex: 1; background: #0f172a; border-radius: 12px; padding: 1rem; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .invoice-preview img { max-width: 100%; max-height: 200px; border-radius: 8px; object-fit: contain; }
        .invoice-preview .pdf-placeholder { text-align: center; color: #64748b; }
        
        .upload-btn { margin-top: 1rem; background: linear-gradient(to right, #a78bfa, #818cf8); border: none; padding: 0.875rem 1.5rem; border-radius: 10px; font-weight: 600; color: #fff; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; }
        .upload-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(167,139,250,0.3); }
        .upload-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* AI Agent Center */
        .ai-agent-center { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .ai-avatar { width: 100px; height: 100px; border-radius: 24px; background: linear-gradient(135deg, #34d399, #22d3d1); display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; color: #020617; margin-bottom: 1.5rem; position: relative; }
        .ai-avatar::after { content: ''; position: absolute; inset: -4px; border-radius: 28px; border: 2px solid transparent; background: linear-gradient(135deg, #34d399, #22d3d1) border-box; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; opacity: 0; animation: pulse-ring 2s ease-out infinite; }
        .ai-agent-center.processing .ai-avatar::after { opacity: 1; }
        
        @keyframes pulse-ring { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.2); opacity: 0; } }
        
        .ai-status { font-size: 1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .ai-message { font-size: 0.85rem; color: #94a3b8; margin-bottom: 1.5rem; min-height: 40px; }
        
        /* Processing Steps */
        .processing-steps { width: 100%; }
        .step-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(51,65,85,0.2); border-radius: 10px; margin-bottom: 0.5rem; font-size: 0.85rem; transition: all 0.3s; }
        .step-item.active { background: rgba(167,139,250,0.15); }
        .step-item.completed { background: rgba(52,211,153,0.1); }
        .step-icon { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: rgba(100,116,139,0.3); color: #64748b; flex-shrink: 0; }
        .step-item.active .step-icon { background: rgba(167,139,250,0.3); color: #a78bfa; }
        .step-item.completed .step-icon { background: rgba(52,211,153,0.3); color: #34d399; }
        .step-text { color: #94a3b8; }
        .step-item.active .step-text { color: #fff; }
        .step-item.completed .step-text { color: #e2e8f0; }
        
        /* Spinner */
        .spinner { width: 16px; height: 16px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* ZATCA Section */
        .zatca-content { display: flex; flex-direction: column; gap: 1rem; }
        .zatca-status-box { background: rgba(51,65,85,0.3); border-radius: 12px; padding: 1.25rem; text-align: center; }
        .zatca-logo { width: 80px; height: 80px; background: rgba(251,191,36,0.15); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; }
        .zatca-logo img { width: 60px; height: 60px; }
        .zatca-title { font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem; }
        .zatca-subtitle { font-size: 0.8rem; color: #64748b; }
        
        /* Validation Results */
        .validation-result { display: none; flex-direction: column; gap: 0.75rem; }
        .validation-result.show { display: flex; }
        .result-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(51,65,85,0.2); border-radius: 10px; font-size: 0.85rem; }
        .result-item.success { background: rgba(52,211,153,0.1); }
        .result-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .result-item.success .result-icon { background: rgba(52,211,153,0.3); color: #34d399; }
        
        /* Approved Invoice */
        .approved-invoice { display: none; }
        .approved-invoice.show { display: block; }
        .approved-badge { display: flex; align-items: center; justify-content: center; gap: 0.5rem; background: rgba(52,211,153,0.15); border: 1px solid rgba(52,211,153,0.3); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .approved-badge span { color: #34d399; font-weight: 600; font-size: 0.9rem; }
        
        .qr-code-box { background: #fff; border-radius: 12px; padding: 1rem; text-align: center; margin-bottom: 1rem; }
        .qr-code { width: 120px; height: 120px; background: linear-gradient(45deg, #000 25%, transparent 25%), linear-gradient(-45deg, #000 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #000 75%), linear-gradient(-45deg, transparent 75%, #000 75%); background-size: 20px 20px; background-position: 0 0, 0 10px, 10px -10px, -10px 0px; margin: 0 auto 0.5rem; border-radius: 8px; }
        .qr-label { font-size: 0.7rem; color: #64748b; }
        
        .invoice-id { background: rgba(51,65,85,0.3); border-radius: 10px; padding: 1rem; }
        .invoice-id-label { font-size: 0.75rem; color: #64748b; margin-bottom: 0.25rem; }
        .invoice-id-value { font-family: 'Courier New', monospace; font-size: 0.8rem; color: #a78bfa; word-break: break-all; }
        
        .download-btn { margin-top: 1rem; background: linear-gradient(to right, #34d399, #22d3d1); border: none; padding: 0.875rem 1.5rem; border-radius: 10px; font-weight: 600; color: #020617; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; }
        .download-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(52,211,153,0.3); }
        
        /* Customer Delivery */
        .customer-delivery { display: none; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #1e293b; }
        .customer-delivery.show { display: block; }
        .delivery-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
        .delivery-icon { width: 40px; height: 40px; background: rgba(167,139,250,0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
        .delivery-title { font-size: 0.9rem; font-weight: 600; }
        .delivery-subtitle { font-size: 0.75rem; color: #64748b; }
        .delivery-options { display: flex; gap: 0.5rem; }
        .delivery-option { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 0.5rem; padding: 1rem; background: rgba(51,65,85,0.3); border-radius: 10px; cursor: pointer; transition: all 0.3s; border: 1px solid transparent; }
        .delivery-option:hover { background: rgba(167,139,250,0.1); border-color: rgba(167,139,250,0.3); }
        .delivery-option span { font-size: 0.75rem; color: #94a3b8; }
        
        /* Reset Button */
        .reset-section { text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid #1e293b; }
        .reset-btn { background: rgba(51,65,85,0.5); border: 1px solid #334155; padding: 0.75rem 2rem; border-radius: 10px; color: #94a3b8; cursor: pointer; font-size: 0.875rem; transition: all 0.3s; }
        .reset-btn:hover { background: rgba(51,65,85,0.8); color: #fff; }
        
        /* Language */
        .en { display: none; }
        .ar { display: inline; }
        [dir="ltr"] .en { display: inline; }
        [dir="ltr"] .ar { display: none; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.5s ease forwards; }
        
        /* Mobile Adjustments */
        @media(max-width: 768px) {
            .demo-container { padding: 6rem 1rem 2rem; }
            .demo-card { min-height: auto; }
            .page-title { font-size: 1.75rem; }
        }
        
        /* ============================================== */
        /* ACCOUNTING SECTION STYLES */
        /* ============================================== */
        
        .accounting-section { margin-top: 3rem; animation: fadeIn 0.8s ease forwards; }
        
        /* Section Divider */
        .section-divider { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2.5rem; }
        .divider-line { flex: 1; height: 1px; background: linear-gradient(to right, transparent, #334155, transparent); }
        .divider-badge { display: flex; align-items: center; gap: 0.5rem; background: linear-gradient(135deg, rgba(52,211,153,0.15), rgba(34,211,209,0.1)); border: 1px solid rgba(52,211,153,0.3); border-radius: 50px; padding: 0.75rem 1.5rem; color: #34d399; font-size: 0.9rem; font-weight: 600; }
        
        .accounting-header { text-align: center; margin-bottom: 2rem; }
        .gradient-text-green { background: linear-gradient(to left, #34d399, #22d3d1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        
        /* Two Column Grid */
        .accounting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        @media(max-width: 1024px) { .accounting-grid { grid-template-columns: 1fr; } }
        
        /* Panel Styles */
        .accounting-panel { background: linear-gradient(135deg, rgba(30,41,59,0.9), rgba(15,23,42,0.9)); border-radius: 20px; border: 1px solid #1e293b; overflow: hidden; transition: all 0.3s; }
        .accounting-panel:hover { border-color: rgba(52,211,153,0.3); }
        .sales-panel:hover { border-color: rgba(52,211,153,0.5); }
        .expenses-panel:hover { border-color: rgba(251,146,60,0.5); }
        
        .panel-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid #1e293b; display: flex; align-items: center; gap: 1rem; }
        .panel-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .panel-icon.sales { background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(34,211,209,0.2)); color: #34d399; }
        .panel-icon.expenses { background: linear-gradient(135deg, rgba(251,146,60,0.2), rgba(249,115,22,0.2)); color: #fb923c; }
        .panel-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; }
        .panel-title { font-size: 1rem; font-weight: 700; }
        .panel-status { margin-right: auto; margin-left: 0; }
        [dir="ltr"] .panel-status { margin-left: auto; margin-right: 0; }
        
        .panel-content { padding: 1.5rem; }
        
        /* Summary Cards */
        .summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin-bottom: 1.5rem; }
        .summary-card { background: rgba(51,65,85,0.3); border-radius: 12px; padding: 1rem; text-align: center; transition: all 0.3s; }
        .summary-card.highlight { background: rgba(52,211,153,0.15); border: 1px solid rgba(52,211,153,0.3); }
        .summary-icon { color: #64748b; margin-bottom: 0.5rem; }
        .summary-card.highlight .summary-icon { color: #34d399; }
        .summary-value { font-size: 1.25rem; font-weight: 700; color: #fff; }
        .summary-card.highlight .summary-value { color: #34d399; }
        .summary-label { font-size: 0.7rem; color: #64748b; margin-top: 0.25rem; }
        
        /* Invoice List */
        .invoice-list { background: rgba(15,23,42,0.5); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; }
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; font-size: 0.85rem; color: #94a3b8; }
        .list-count { background: rgba(52,211,153,0.2); color: #34d399; padding: 0.15rem 0.5rem; border-radius: 50px; font-size: 0.75rem; }
        
        .invoice-items { max-height: 200px; overflow-y: auto; }
        .invoice-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: rgba(51,65,85,0.2); border-radius: 10px; margin-bottom: 0.5rem; transition: all 0.3s; }
        .invoice-item:hover { background: rgba(51,65,85,0.4); }
        .invoice-item:last-child { margin-bottom: 0; }
        .invoice-item-icon { width: 36px; height: 36px; background: rgba(52,211,153,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #34d399; flex-shrink: 0; }
        .invoice-item-details { flex: 1; min-width: 0; }
        .invoice-item-title { font-size: 0.8rem; font-weight: 600; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .invoice-item-meta { font-size: 0.7rem; color: #64748b; }
        .invoice-item-amount { text-align: left; }
        [dir="ltr"] .invoice-item-amount { text-align: right; }
        .invoice-item-amount .amount { font-size: 0.9rem; font-weight: 600; color: #34d399; }
        .invoice-item-amount .amount small { font-size: 0.65rem; color: #64748b; }
        .vat-badge { font-size: 0.65rem; color: #64748b; }
        
        .add-invoice-btn { width: 100%; padding: 0.75rem; background: rgba(52,211,153,0.1); border: 1px dashed rgba(52,211,153,0.3); border-radius: 10px; color: #34d399; font-size: 0.85rem; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .add-invoice-btn:hover { background: rgba(52,211,153,0.2); border-style: solid; }
        
        /* Sales Bulk Upload */
        .sales-bulk-upload { margin-bottom: 1rem; }
        .sales-upload-zone { 
            background: rgba(15,23,42,0.5); 
            border: 2px dashed rgba(52,211,153,0.3); 
            border-radius: 12px; 
            padding: 1.25rem; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s;
        }
        .sales-upload-zone:hover { border-color: rgba(52,211,153,0.6); background: rgba(52,211,153,0.1); }
        .sales-upload-zone.drag-over { border-color: #34d399; background: rgba(52,211,153,0.15); }
        .sales-upload-zone.has-files { border-style: solid; border-color: #34d399; }
        .sales-upload-icon { margin-bottom: 0.5rem; }
        .sales-upload-text { font-size: 0.85rem; color: #e2e8f0; margin-bottom: 0.25rem; }
        .sales-upload-hint { font-size: 0.75rem; color: #64748b; }
        
        .sales-files-preview { display: none; margin-top: 1rem; }
        .sales-files-preview.show { display: block; }
        .sales-files-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; font-size: 0.8rem; }
        .sales-files-count { color: #34d399; font-weight: 600; }
        .sales-files-clear { background: none; border: none; color: #64748b; font-size: 0.75rem; cursor: pointer; }
        .sales-files-clear:hover { color: #f87171; }
        .sales-files-list { display: flex; flex-wrap: wrap; gap: 0.5rem; max-height: 100px; overflow-y: auto; }
        .sales-file-tag { display: flex; align-items: center; gap: 0.35rem; background: rgba(52,211,153,0.15); border: 1px solid rgba(52,211,153,0.3); padding: 0.35rem 0.6rem; border-radius: 6px; font-size: 0.75rem; color: #34d399; }
        .sales-file-tag button { background: none; border: none; color: #64748b; cursor: pointer; padding: 0; margin-left: 0.25rem; }
        .sales-file-tag button:hover { color: #f87171; }
        
        .process-sales-btn { 
            width: 100%; 
            margin-top: 0.75rem; 
            padding: 0.75rem; 
            background: linear-gradient(135deg, #34d399, #22d3d1); 
            border: none; 
            border-radius: 10px; 
            color: #020617; 
            font-size: 0.85rem; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .process-sales-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52,211,153,0.3); }
        .process-sales-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .sales-divider { display: flex; align-items: center; gap: 0.75rem; margin: 1rem 0; }
        .sales-divider-line { flex: 1; height: 1px; background: #334155; }
        .sales-divider-text { font-size: 0.7rem; color: #64748b; text-transform: uppercase; }
        
        .invoice-empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem 1rem; text-align: center; }
        
        /* Expense Categories */
        .expense-categories { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem; }
        .expense-category { background: rgba(15,23,42,0.5); border-radius: 12px; overflow: hidden; border: 1px solid transparent; transition: all 0.3s; }
        .expense-category.active { border-color: rgba(251,146,60,0.3); }
        .expense-category.has-expenses { border-color: rgba(52,211,153,0.3); }
        
        .category-header { display: flex; align-items: center; gap: 0.75rem; padding: 0.875rem 1rem; cursor: pointer; transition: all 0.3s; }
        .category-header:hover { background: rgba(51,65,85,0.3); }
        .category-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .category-icon.suppliers { background: rgba(96,165,250,0.2); color: #60a5fa; }
        .category-icon.salaries { background: rgba(167,139,250,0.2); color: #a78bfa; }
        .category-icon.rent { background: rgba(251,146,60,0.2); color: #fb923c; }
        .category-icon.misc { background: rgba(148,163,184,0.2); color: #94a3b8; }
        .category-info { flex: 1; }
        .category-title { font-size: 0.85rem; font-weight: 600; color: #e2e8f0; }
        .category-hint { font-size: 0.7rem; color: #64748b; }
        .category-amount { font-size: 0.85rem; font-weight: 600; color: #64748b; transition: color 0.3s; }
        .expense-category.has-expenses .category-amount { color: #34d399; }
        .category-chevron { color: #64748b; transition: transform 0.3s; }
        .expense-category.active .category-chevron { transform: rotate(180deg); }
        
        .category-upload { display: none; padding: 0 1rem 1rem; }
        .expense-category.active .category-upload { display: block; }
        
        .mini-upload-zone { display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem; background: rgba(51,65,85,0.3); border: 1px dashed #475569; border-radius: 8px; color: #94a3b8; font-size: 0.8rem; cursor: pointer; transition: all 0.3s; }
        .mini-upload-zone:hover { border-color: #fb923c; color: #fb923c; background: rgba(251,146,60,0.1); }
        
        .expense-category input[type="file"] { display: none; }
        
        .uploaded-expenses { margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .uploaded-expense { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.2); border-radius: 8px; font-size: 0.8rem; }
        .uploaded-expense .expense-name { flex: 1; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .uploaded-expense .expense-amount { color: #34d399; font-weight: 600; }
        .uploaded-expense .expense-vat { color: #64748b; font-size: 0.7rem; }
        .uploaded-expense .remove-expense { background: none; border: none; color: #64748b; cursor: pointer; padding: 0.25rem; }
        .uploaded-expense .remove-expense:hover { color: #f87171; }
        
        /* Quick Add Section */
        .quick-add-section { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #1e293b; }
        .quick-add-label { font-size: 0.75rem; color: #64748b; margin-bottom: 0.75rem; text-align: center; }
        .quick-add-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .quick-add-btn { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.75rem 0.5rem; background: rgba(51,65,85,0.3); border: 1px solid #334155; border-radius: 10px; color: #94a3b8; font-size: 0.75rem; cursor: pointer; transition: all 0.3s; }
        .quick-add-btn:hover { background: rgba(52,211,153,0.15); border-color: rgba(52,211,153,0.3); color: #34d399; }
        .quick-add-btn span { font-weight: 600; }
        
        /* ============================================== */
        /* AI BULK EXPENSE CATEGORIZER STYLES */
        /* ============================================== */
        
        .bulk-upload-section { 
            background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(15,23,42,0.95)); 
            border-radius: 24px; 
            border: 2px dashed rgba(167,139,250,0.4); 
            padding: 2rem; 
            margin-bottom: 2rem; 
            transition: all 0.3s;
        }
        .bulk-upload-section:hover { border-color: rgba(167,139,250,0.7); }
        .bulk-upload-section.processing { border-style: solid; border-color: rgba(52,211,153,0.5); }
        .bulk-upload-section.completed { border-style: solid; border-color: rgba(52,211,153,0.7); background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(5,150,105,0.1)); }
        
        .bulk-header { display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .bulk-icon-wrapper { width: 72px; height: 72px; border-radius: 20px; background: linear-gradient(135deg, rgba(167,139,250,0.3), rgba(129,140,248,0.2)); display: flex; align-items: center; justify-content: center; flex-shrink: 0; position: relative; }
        .bulk-icon-wrapper::after { content: ''; position: absolute; inset: -3px; border-radius: 23px; border: 2px solid rgba(167,139,250,0.3); animation: pulse-ring 2s ease-out infinite; }
        .bulk-upload-section.processing .bulk-icon-wrapper::after { border-color: rgba(52,211,153,0.5); }
        .bulk-upload-section.completed .bulk-icon-wrapper { background: linear-gradient(135deg, rgba(52,211,153,0.3), rgba(34,211,209,0.2)); }
        .bulk-header-content { flex: 1; min-width: 200px; }
        .bulk-title { font-size: 1.25rem; font-weight: 700; color: #fff; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem; }
        .bulk-title .ai-badge { background: linear-gradient(135deg, #a78bfa, #818cf8); padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .bulk-subtitle { color: #94a3b8; font-size: 0.9rem; }
        
        .bulk-upload-zone { 
            background: rgba(15,23,42,0.5); 
            border: 2px dashed #475569; 
            border-radius: 16px; 
            padding: 2.5rem; 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s;
            margin-bottom: 1.5rem;
        }
        .bulk-upload-zone:hover { border-color: #a78bfa; background: rgba(167,139,250,0.1); }
        .bulk-upload-zone.drag-over { border-color: #a78bfa; background: rgba(167,139,250,0.15); transform: scale(1.01); }
        .bulk-upload-zone.has-files { border-style: solid; border-color: #34d399; background: rgba(52,211,153,0.1); }
        
        .bulk-upload-icon { font-size: 3.5rem; margin-bottom: 1rem; }
        .bulk-upload-icon i { color: #64748b; }
        .bulk-upload-zone:hover .bulk-upload-icon i { color: #a78bfa; }
        .bulk-upload-zone.has-files .bulk-upload-icon i { color: #34d399; }
        
        .bulk-upload-text { font-size: 1rem; color: #e2e8f0; margin-bottom: 0.5rem; font-weight: 500; }
        .bulk-upload-hint { font-size: 0.85rem; color: #64748b; }
        .bulk-upload-formats { display: flex; gap: 0.5rem; justify-content: center; margin-top: 1rem; flex-wrap: wrap; }
        .format-badge { background: rgba(51,65,85,0.5); padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.75rem; color: #94a3b8; }
        
        /* File List Preview */
        .bulk-files-preview { display: none; margin-bottom: 1.5rem; }
        .bulk-files-preview.show { display: block; }
        .files-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid #334155; }
        .files-count { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: #e2e8f0; }
        .files-count .count-badge { background: rgba(167,139,250,0.2); color: #a78bfa; padding: 0.25rem 0.75rem; border-radius: 50px; font-weight: 600; }
        .files-clear { background: none; border: none; color: #64748b; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 0.35rem; transition: color 0.3s; }
        .files-clear:hover { color: #f87171; }
        
        .files-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 0.75rem; max-height: 200px; overflow-y: auto; padding: 0.25rem; }
        .file-chip { display: flex; align-items: center; gap: 0.5rem; background: rgba(51,65,85,0.4); border: 1px solid #475569; border-radius: 10px; padding: 0.6rem 0.75rem; font-size: 0.8rem; }
        .file-chip-icon { color: #a78bfa; flex-shrink: 0; }
        .file-chip-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #e2e8f0; }
        .file-chip-remove { background: none; border: none; color: #64748b; cursor: pointer; padding: 0.25rem; transition: color 0.3s; }
        .file-chip-remove:hover { color: #f87171; }
        
        /* AI Categorization Button */
        .categorize-btn { 
            width: 100%; 
            background: linear-gradient(135deg, #a78bfa, #818cf8); 
            border: none; 
            padding: 1rem 2rem; 
            border-radius: 14px; 
            font-size: 1rem; 
            font-weight: 700; 
            color: #fff; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .categorize-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(167,139,250,0.4); }
        .categorize-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .categorize-btn.processing { background: linear-gradient(135deg, #34d399, #22d3d1); }
        
        /* AI Processing Animation */
        .ai-categorization-engine { display: none; margin-top: 2rem; }
        .ai-categorization-engine.show { display: block; animation: fadeIn 0.5s ease; }
        
        .engine-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .engine-avatar { width: 60px; height: 60px; border-radius: 16px; background: linear-gradient(135deg, #34d399, #22d3d1); display: flex; align-items: center; justify-content: center; font-weight: bold; color: #020617; font-size: 1.5rem; position: relative; }
        .engine-avatar-ring { position: absolute; inset: -5px; border-radius: 20px; border: 2px solid #34d399; animation: pulse-ring 1.2s ease-out infinite; }
        .engine-status { flex: 1; }
        .engine-status-text { font-size: 1.1rem; font-weight: 600; color: #34d399; margin-bottom: 0.25rem; }
        .engine-status-detail { font-size: 0.85rem; color: #94a3b8; }
        
        /* Processing Steps */
        .categorization-steps { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        @media(max-width: 768px) { .categorization-steps { grid-template-columns: repeat(2, 1fr); } }
        .cat-step { background: rgba(51,65,85,0.3); border-radius: 12px; padding: 1rem; text-align: center; transition: all 0.3s; border: 1px solid transparent; }
        .cat-step.active { background: rgba(167,139,250,0.15); border-color: rgba(167,139,250,0.3); }
        .cat-step.completed { background: rgba(52,211,153,0.1); border-color: rgba(52,211,153,0.3); }
        .cat-step-icon { width: 40px; height: 40px; border-radius: 10px; background: rgba(100,116,139,0.3); display: flex; align-items: center; justify-content: center; margin: 0 auto 0.75rem; color: #64748b; transition: all 0.3s; }
        .cat-step.active .cat-step-icon { background: rgba(167,139,250,0.3); color: #a78bfa; }
        .cat-step.completed .cat-step-icon { background: rgba(52,211,153,0.3); color: #34d399; }
        .cat-step-label { font-size: 0.8rem; color: #94a3b8; }
        .cat-step.active .cat-step-label { color: #e2e8f0; }
        .cat-step.completed .cat-step-label { color: #34d399; }
        
        /* Categorization Results */
        .categorization-results { display: none; animation: fadeIn 0.5s ease; }
        .categorization-results.show { display: block; }
        
        .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; flex-wrap: wrap; gap: 1rem; }
        .results-title { display: flex; align-items: center; gap: 0.75rem; font-size: 1rem; font-weight: 600; color: #34d399; }
        .results-summary { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .result-tag { display: flex; align-items: center; gap: 0.35rem; background: rgba(51,65,85,0.4); padding: 0.4rem 0.75rem; border-radius: 8px; font-size: 0.8rem; }
        .result-tag.suppliers { color: #60a5fa; border-left: 3px solid #60a5fa; }
        .result-tag.salaries { color: #a78bfa; border-left: 3px solid #a78bfa; }
        .result-tag.rent { color: #fb923c; border-left: 3px solid #fb923c; }
        .result-tag.misc { color: #94a3b8; border-left: 3px solid #94a3b8; }
        [dir="ltr"] .result-tag { border-left: none; border-right: 3px solid; }
        [dir="ltr"] .result-tag.suppliers { border-right-color: #60a5fa; }
        [dir="ltr"] .result-tag.salaries { border-right-color: #a78bfa; }
        [dir="ltr"] .result-tag.rent { border-right-color: #fb923c; }
        [dir="ltr"] .result-tag.misc { border-right-color: #94a3b8; }
        
        .results-categories { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        @media(max-width: 768px) { .results-categories { grid-template-columns: 1fr; } }
        
        .result-category { background: rgba(15,23,42,0.5); border-radius: 14px; padding: 1rem; border: 1px solid #334155; transition: all 0.3s; }
        .result-category:hover { border-color: rgba(167,139,250,0.3); }
        .result-category-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .result-cat-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .result-cat-icon.suppliers { background: rgba(96,165,250,0.2); color: #60a5fa; }
        .result-cat-icon.salaries { background: rgba(167,139,250,0.2); color: #a78bfa; }
        .result-cat-icon.rent { background: rgba(251,146,60,0.2); color: #fb923c; }
        .result-cat-icon.misc { background: rgba(148,163,184,0.2); color: #94a3b8; }
        .result-cat-title { flex: 1; font-size: 0.9rem; font-weight: 600; color: #e2e8f0; }
        .result-cat-count { background: rgba(52,211,153,0.2); color: #34d399; padding: 0.2rem 0.6rem; border-radius: 50px; font-size: 0.75rem; font-weight: 600; }
        
        .result-cat-items { display: flex; flex-direction: column; gap: 0.5rem; max-height: 150px; overflow-y: auto; }
        .result-cat-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.75rem; background: rgba(51,65,85,0.3); border-radius: 8px; font-size: 0.8rem; }
        .result-cat-item-name { flex: 1; color: #e2e8f0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .result-cat-item-amount { color: #34d399; font-weight: 600; }
        .result-cat-item-vat { color: #64748b; font-size: 0.7rem; }
        
        .result-cat-total { display: flex; justify-content: space-between; padding-top: 0.75rem; margin-top: 0.75rem; border-top: 1px solid #334155; font-size: 0.85rem; }
        .result-cat-total-label { color: #94a3b8; }
        .result-cat-total-value { color: #34d399; font-weight: 700; }
        
        .result-category.empty { opacity: 0.5; }
        .result-category.empty .result-cat-items { display: none; }
        .empty-message { color: #64748b; font-size: 0.8rem; text-align: center; padding: 1rem; }
        
        /* Apply Button */
        .apply-results-btn { 
            width: 100%; 
            background: linear-gradient(135deg, #34d399, #22d3d1); 
            border: none; 
            padding: 1rem 2rem; 
            border-radius: 14px; 
            font-size: 1rem; 
            font-weight: 700; 
            color: #020617; 
            cursor: pointer; 
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }
        .apply-results-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(52,211,153,0.4); }
        
        /* Success Animation */
        .categorization-success { display: none; text-align: center; padding: 2rem; animation: fadeIn 0.5s ease; }
        .categorization-success.show { display: block; }
        .success-icon { width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, rgba(52,211,153,0.2), rgba(34,211,209,0.1)); display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem; }
        .success-title { font-size: 1.25rem; font-weight: 700; color: #34d399; margin-bottom: 0.5rem; }
        .success-message { color: #94a3b8; font-size: 0.9rem; }
        
        /* AI Expense Processor */
        .ai-expense-processor { background: linear-gradient(135deg, rgba(52,211,153,0.1), rgba(34,211,209,0.05)); border: 1px solid rgba(52,211,153,0.3); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; }
        .processor-content { display: flex; align-items: center; justify-content: center; gap: 1rem; }
        .processor-avatar { width: 50px; height: 50px; background: linear-gradient(135deg, #34d399, #22d3d1); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #020617; font-size: 1.25rem; position: relative; }
        .processor-ring { position: absolute; inset: -4px; border-radius: 16px; border: 2px solid #34d399; animation: pulse-ring 1.5s ease-out infinite; }
        .processor-text { font-size: 1rem; color: #34d399; font-weight: 500; }
        
        /* Reconciliation Section */
        .reconciliation-section { background: linear-gradient(135deg, rgba(30,41,59,0.95), rgba(15,23,42,0.95)); border-radius: 24px; border: 1px solid #1e293b; padding: 2rem; }
        .reconciliation-header { text-align: center; margin-bottom: 1.5rem; }
        .recon-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: rgba(167,139,250,0.15); border: 1px solid rgba(167,139,250,0.3); border-radius: 50px; padding: 0.5rem 1.25rem; color: #a78bfa; font-size: 0.85rem; font-weight: 600; }
        
        /* VAT Reconciliation Cards */
        .vat-reconciliation { display: flex; align-items: center; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .vat-card { background: rgba(51,65,85,0.3); border-radius: 16px; padding: 1.25rem 1.5rem; text-align: center; min-width: 140px; flex: 1; max-width: 200px; transition: all 0.3s; }
        .vat-card.output { border: 1px solid rgba(52,211,153,0.3); }
        .vat-card.input { border: 1px solid rgba(251,146,60,0.3); }
        .vat-card.net { border: 1px solid rgba(167,139,250,0.3); background: rgba(167,139,250,0.1); }
        .vat-card.net.refund { border-color: rgba(52,211,153,0.5); background: rgba(52,211,153,0.15); }
        .vat-card-header { display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.75rem; font-size: 0.8rem; color: #94a3b8; }
        .vat-card.output .vat-card-header { color: #34d399; }
        .vat-card.input .vat-card-header { color: #fb923c; }
        .vat-card.net .vat-card-header { color: #a78bfa; }
        .vat-card-value { font-size: 1.5rem; font-weight: 700; color: #fff; }
        .vat-card.output .vat-card-value { color: #34d399; }
        .vat-card.input .vat-card-value { color: #fb923c; }
        .vat-card.net .vat-card-value { color: #a78bfa; }
        .vat-card.net.refund .vat-card-value { color: #34d399; }
        .vat-card-label { font-size: 0.7rem; color: #64748b; margin-top: 0.5rem; }
        
        .vat-operator { font-size: 1.5rem; font-weight: bold; color: #64748b; padding: 0 0.5rem; }
        
        /* Financial Summary */
        .financial-summary { margin-bottom: 2rem; }
        .summary-title { display: flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 1rem; color: #e2e8f0; margin-bottom: 1.25rem; }
        
        .pnl-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
        @media(max-width: 768px) { .pnl-grid { grid-template-columns: repeat(2, 1fr); } }
        .pnl-item { background: rgba(51,65,85,0.3); border-radius: 12px; padding: 1rem; text-align: center; }
        .pnl-item.revenue { border-bottom: 3px solid #34d399; }
        .pnl-item.expenses { border-bottom: 3px solid #fb923c; }
        .pnl-item.profit { border-bottom: 3px solid #a78bfa; }
        .pnl-item.profit.loss { border-bottom-color: #f87171; }
        .pnl-item.margin { border-bottom: 3px solid #22d3d1; }
        .pnl-label { font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.5rem; }
        .pnl-value { font-size: 1.25rem; font-weight: 700; }
        .pnl-item.revenue .pnl-value { color: #34d399; }
        .pnl-item.expenses .pnl-value { color: #fb923c; }
        .pnl-item.profit .pnl-value { color: #a78bfa; }
        .pnl-item.profit.loss .pnl-value { color: #f87171; }
        .pnl-item.margin .pnl-value { color: #22d3d1; }
        
        /* Expense Breakdown */
        .expense-breakdown { background: rgba(15,23,42,0.5); border-radius: 12px; padding: 1.25rem; }
        .breakdown-title { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #94a3b8; margin-bottom: 1rem; font-weight: 600; }
        .breakdown-bars { display: flex; flex-direction: column; gap: 0.75rem; }
        .breakdown-item { display: grid; grid-template-columns: 80px 1fr 80px; align-items: center; gap: 1rem; }
        .breakdown-label { font-size: 0.8rem; color: #94a3b8; }
        .breakdown-bar { height: 8px; background: rgba(51,65,85,0.5); border-radius: 4px; overflow: hidden; }
        .breakdown-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        .breakdown-fill.suppliers { background: linear-gradient(to right, #3b82f6, #60a5fa); }
        .breakdown-fill.salaries { background: linear-gradient(to right, #8b5cf6, #a78bfa); }
        .breakdown-fill.rent { background: linear-gradient(to right, #f97316, #fb923c); }
        .breakdown-fill.misc { background: linear-gradient(to right, #64748b, #94a3b8); }
        .breakdown-value { font-size: 0.8rem; color: #e2e8f0; text-align: left; }
        [dir="ltr"] .breakdown-value { text-align: right; }
        
        /* Report Actions */
        .report-actions { display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .report-btn { display: flex; align-items: center; gap: 0.5rem; padding: 1rem 2rem; border-radius: 12px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s; border: none; }
        .report-btn:not(.secondary) { background: linear-gradient(to right, #a78bfa, #818cf8); color: #fff; }
        .report-btn:not(.secondary):hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(167,139,250,0.35); }
        .report-btn.secondary { background: rgba(51,65,85,0.5); border: 1px solid #475569; color: #94a3b8; }
        .report-btn.secondary:hover { background: rgba(51,65,85,0.8); color: #fff; }
        
        @media(max-width: 768px) {
            .summary-cards { grid-template-columns: 1fr; }
            .vat-reconciliation { flex-direction: column; }
            .vat-card { max-width: 100%; }
            .vat-operator { transform: rotate(90deg); padding: 0.5rem 0; }
            .quick-add-buttons { grid-template-columns: repeat(2, 1fr); }
            .breakdown-item { grid-template-columns: 60px 1fr 60px; gap: 0.5rem; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-inner">
        <div class="logo">
            <div class="logo-icon">م</div>
            <span class="logo-text">Muhasib</span>
        </div>
        <div class="header-actions">
            <a href="index.html" class="back-btn">
                <i data-lucide="arrow-right" class="icon"></i>
                <span class="ar">الرجوع للرئيسية</span>
                <span class="en">Back to Home</span>
            </a>
            <div class="lang-toggle">
                <button class="lang-btn active" id="btn-ar" onclick="setLang('ar')">عربي</button>
                <button class="lang-btn" id="btn-en" onclick="setLang('en')">EN</button>
            </div>
        </div>
    </div>
</header>

<main class="demo-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-badge">
            <i data-lucide="zap" class="icon icon-sm"></i>
            <span class="ar">تجربة تفاعلية</span>
            <span class="en">Interactive Demo</span>
        </div>
        <h1 class="page-title">
            <span class="gradient-text"><span class="ar">فوترة إلكترونية متوافقة مع زاتكا</span><span class="en">ZATCA Compliant E-Invoicing</span></span>
        </h1>
        <p class="page-subtitle">
            <span class="ar">شاهد كيف يساعدك محاسب AI في إصدار فواتير إلكترونية معتمدة من الحكومة بخطوات بسيطة</span>
            <span class="en">See how Muhasib AI helps you issue government-approved e-invoices in simple steps</span>
        </p>
    </div>
    
    <!-- Demo Flow -->
    <div class="demo-flow">
        <!-- Card 1: Business/Upload -->
        <div class="demo-card" id="card-business">
            <div class="card-header">
                <div class="card-icon-wrapper business">
                    <i data-lucide="building-2" class="icon icon-xl icon-purple"></i>
                </div>
                <div>
                    <div class="card-label"><span class="ar">الخطوة ١</span><span class="en">Step 1</span></div>
                    <div class="card-title"><span class="ar">رفع الفاتورة</span><span class="en">Upload Invoice</span></div>
                </div>
                <div class="card-status">
                    <span class="status-badge waiting" id="status-business">
                        <span class="ar">في انتظار الفاتورة</span>
                        <span class="en">Waiting for invoice</span>
                    </span>
                </div>
            </div>
            <div class="card-content">
                <!-- Upload Zone -->
                <div class="upload-zone" id="upload-zone">
                    <input type="file" class="upload-input" id="file-input" accept="image/*,.pdf">
                    <div class="upload-icon">
                        <i data-lucide="upload-cloud" class="icon icon-4xl"></i>
                    </div>
                    <div class="upload-text">
                        <span class="ar">اسحب الفاتورة هنا أو انقر للرفع</span>
                        <span class="en">Drag invoice here or click to upload</span>
                    </div>
                    <div class="upload-hint">
                        <span class="ar">PDF, PNG, JPG (حد أقصى 10MB)</span>
                        <span class="en">PDF, PNG, JPG (max 10MB)</span>
                    </div>
                </div>
                
                <!-- File Preview -->
                <div class="file-preview" id="file-preview">
                    <div class="file-info">
                        <div class="file-icon">
                            <i data-lucide="file-text" class="icon icon-xl icon-purple"></i>
                        </div>
                        <div>
                            <div class="file-name" id="file-name">invoice.pdf</div>
                            <div class="file-size" id="file-size">2.4 MB</div>
                        </div>
                        <button class="file-remove" id="file-remove">
                            <i data-lucide="x" class="icon icon-lg"></i>
                        </button>
                    </div>
                    <div class="invoice-preview" id="invoice-preview">
                        <div class="pdf-placeholder">
                            <i data-lucide="file-text" class="icon icon-3xl" style="color:#64748b;"></i>
                            <p style="margin-top:0.5rem;font-size:0.8rem;"><span class="ar">معاينة الفاتورة</span><span class="en">Invoice Preview</span></p>
                        </div>
                    </div>
                    <button class="upload-btn" id="process-btn">
                        <i data-lucide="send" class="icon"></i>
                        <span class="ar">إرسال للمعالجة</span>
                        <span class="en">Send for Processing</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Arrow 1 -->
        <div class="flow-arrow" id="arrow-1">
            <i data-lucide="arrow-left" class="icon"></i>
        </div>
        
        <!-- Card 2: AI Agent -->
        <div class="demo-card" id="card-ai">
            <div class="card-header">
                <div class="card-icon-wrapper ai">
                    <i data-lucide="bot" class="icon icon-xl icon-emerald"></i>
                </div>
                <div>
                    <div class="card-label"><span class="ar">الخطوة ٢</span><span class="en">Step 2</span></div>
                    <div class="card-title"><span class="ar">معالجة AI</span><span class="en">AI Processing</span></div>
                </div>
                <div class="card-status">
                    <span class="status-badge waiting" id="status-ai">
                        <span class="ar">في انتظار البيانات</span>
                        <span class="en">Waiting for data</span>
                    </span>
                </div>
            </div>
            <div class="card-content">
                <div class="ai-agent-center" id="ai-agent">
                    <div class="ai-avatar">م</div>
                    <div class="ai-status" id="ai-status-text">
                        <span class="ar">جاهز للمعالجة</span>
                        <span class="en">Ready to Process</span>
                    </div>
                    <div class="ai-message" id="ai-message">
                        <span class="ar">ارفع فاتورتك وسأقوم بالتحقق منها وإرسالها لزاتكا</span>
                        <span class="en">Upload your invoice and I'll validate it and send to ZATCA</span>
                    </div>
                    
                    <!-- Processing Steps -->
                    <div class="processing-steps" id="processing-steps">
                        <div class="step-item" id="step-1">
                            <div class="step-icon"><i data-lucide="scan" class="icon icon-sm"></i></div>
                            <span class="step-text"><span class="ar">قراءة بيانات الفاتورة</span><span class="en">Reading invoice data</span></span>
                        </div>
                        <div class="step-item" id="step-2">
                            <div class="step-icon"><i data-lucide="check-circle" class="icon icon-sm"></i></div>
                            <span class="step-text"><span class="ar">التحقق من الامتثال</span><span class="en">Validating compliance</span></span>
                        </div>
                        <div class="step-item" id="step-3">
                            <div class="step-icon"><i data-lucide="calculator" class="icon icon-sm"></i></div>
                            <span class="step-text"><span class="ar">حساب الضريبة</span><span class="en">Calculating VAT</span></span>
                        </div>
                        <div class="step-item" id="step-4">
                            <div class="step-icon"><i data-lucide="send" class="icon icon-sm"></i></div>
                            <span class="step-text"><span class="ar">إرسال إلى زاتكا</span><span class="en">Sending to ZATCA</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Arrow 2 -->
        <div class="flow-arrow" id="arrow-2">
            <i data-lucide="arrow-left" class="icon"></i>
        </div>
        
        <!-- Card 3: ZATCA & Customer -->
        <div class="demo-card" id="card-zatca">
            <div class="card-header">
                <div class="card-icon-wrapper zatca">
                    <i data-lucide="shield-check" class="icon icon-xl icon-amber"></i>
                </div>
                <div>
                    <div class="card-label"><span class="ar">الخطوة ٣</span><span class="en">Step 3</span></div>
                    <div class="card-title"><span class="ar">اعتماد زاتكا</span><span class="en">ZATCA Approval</span></div>
                </div>
                <div class="card-status">
                    <span class="status-badge waiting" id="status-zatca">
                        <span class="ar">في الانتظار</span>
                        <span class="en">Waiting</span>
                    </span>
                </div>
            </div>
            <div class="card-content">
                <div class="zatca-content">
                    <!-- Initial State -->
                    <div class="zatca-status-box" id="zatca-waiting">
                        <div class="zatca-logo">
                            <i data-lucide="landmark" class="icon icon-3xl icon-amber"></i>
                        </div>
                        <div class="zatca-title">
                            <span class="ar">بوابة زاتكا</span>
                            <span class="en">ZATCA Portal</span>
                        </div>
                        <div class="zatca-subtitle">
                            <span class="ar">هيئة الزكاة والضريبة والجمارك</span>
                            <span class="en">Zakat, Tax and Customs Authority</span>
                        </div>
                    </div>
                    
                    <!-- Validation Results -->
                    <div class="validation-result" id="validation-result">
                        <div class="result-item success">
                            <div class="result-icon"><i data-lucide="check" class="icon icon-sm"></i></div>
                            <span><span class="ar">الرقم الضريبي صالح</span><span class="en">Tax ID valid</span></span>
                        </div>
                        <div class="result-item success">
                            <div class="result-icon"><i data-lucide="check" class="icon icon-sm"></i></div>
                            <span><span class="ar">بيانات الفاتورة مكتملة</span><span class="en">Invoice data complete</span></span>
                        </div>
                        <div class="result-item success">
                            <div class="result-icon"><i data-lucide="check" class="icon icon-sm"></i></div>
                            <span><span class="ar">حساب الضريبة صحيح</span><span class="en">VAT calculation correct</span></span>
                        </div>
                    </div>
                    
                    <!-- Approved Invoice -->
                    <div class="approved-invoice" id="approved-invoice">
                        <div class="approved-badge">
                            <i data-lucide="badge-check" class="icon icon-lg icon-emerald"></i>
                            <span><span class="ar">تمت الموافقة</span><span class="en">Approved</span></span>
                        </div>
                        <div class="qr-code-box">
                            <div class="qr-code" id="qr-code"></div>
                            <div class="qr-label"><span class="ar">رمز التحقق</span><span class="en">Verification QR</span></div>
                        </div>
                        <div class="invoice-id">
                            <div class="invoice-id-label"><span class="ar">معرّف الفاتورة من زاتكا</span><span class="en">ZATCA Invoice ID</span></div>
                            <div class="invoice-id-value" id="zatca-id">INV-2026-ZATCA-A1B2C3D4E5F6</div>
                        </div>
                        <button class="download-btn" id="download-btn">
                            <i data-lucide="download" class="icon"></i>
                            <span class="ar">تحميل الفاتورة المعتمدة</span>
                            <span class="en">Download Approved Invoice</span>
                        </button>
                    </div>
                    
                    <!-- Customer Delivery -->
                    <div class="customer-delivery" id="customer-delivery">
                        <div class="delivery-header">
                            <div class="delivery-icon">
                                <i data-lucide="user-check" class="icon icon-lg icon-purple"></i>
                            </div>
                            <div>
                                <div class="delivery-title"><span class="ar">إرسال للعميل</span><span class="en">Send to Customer</span></div>
                                <div class="delivery-subtitle"><span class="ar">اختر طريقة الإرسال</span><span class="en">Choose delivery method</span></div>
                            </div>
                        </div>
                        <div class="delivery-options">
                            <div class="delivery-option" onclick="deliverInvoice('whatsapp')">
                                <i data-lucide="message-circle" class="icon icon-xl" style="color:#25D366;"></i>
                                <span>WhatsApp</span>
                            </div>
                            <div class="delivery-option" onclick="deliverInvoice('email')">
                                <i data-lucide="mail" class="icon icon-xl" style="color:#ea4335;"></i>
                                <span><span class="ar">بريد</span><span class="en">Email</span></span>
                            </div>
                            <div class="delivery-option" onclick="deliverInvoice('sms')">
                                <i data-lucide="smartphone" class="icon icon-xl" style="color:#a78bfa;"></i>
                                <span>SMS</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Reset Section -->
    <div class="reset-section" id="reset-section" style="display:none;">
        <button class="reset-btn" onclick="resetDemo()">
            <i data-lucide="rotate-ccw" class="icon icon-sm"></i>
            <span class="ar">إعادة التجربة</span>
            <span class="en">Reset Demo</span>
        </button>
    </div>
    
    <!-- ============================================== -->
    <!-- STEP 4-5: FULL ACCOUNTING & RECONCILIATION -->
    <!-- ============================================== -->
    <div class="accounting-section" id="accounting-section" style="display:none;">
        <div class="section-divider">
            <div class="divider-line"></div>
            <div class="divider-badge">
                <i data-lucide="arrow-down" class="icon"></i>
                <span class="ar">المحاسبة الكاملة</span>
                <span class="en">Complete Accounting</span>
            </div>
            <div class="divider-line"></div>
        </div>
        
        <div class="accounting-header">
            <div class="page-badge" style="background: rgba(52,211,153,0.15); border-color: rgba(52,211,153,0.3); color: #34d399;">
                <i data-lucide="wallet" class="icon icon-sm"></i>
                <span class="ar">الخطوات ٤-٥</span>
                <span class="en">Steps 4-5</span>
            </div>
            <h2 class="page-title" style="font-size: 1.75rem;">
                <span class="gradient-text-green"><span class="ar">التسوية التلقائية والتقارير المالية</span><span class="en">Auto Reconciliation & Financial Reports</span></span>
            </h2>
            <p class="page-subtitle">
                <span class="ar">أضف مصاريفك وشاهد التسوية الضريبية والتقارير المالية لحظياً</span>
                <span class="en">Add your expenses and see VAT reconciliation & financial reports in real-time</span>
            </p>
        </div>
        
        <!-- ============================================== -->
        <!-- AI BULK EXPENSE CATEGORIZER -->
        <!-- ============================================== -->
        <div class="bulk-upload-section" id="bulk-upload-section">
            <div class="bulk-header">
                <div class="bulk-icon-wrapper">
                    <i data-lucide="sparkles" class="icon icon-3xl icon-purple"></i>
                </div>
                <div class="bulk-header-content">
                    <h3 class="bulk-title">
                        <span class="ar">رفع جميع المصاريف دفعة واحدة</span>
                        <span class="en">Upload All Expenses at Once</span>
                        <span class="ai-badge">AI</span>
                    </h3>
                    <p class="bulk-subtitle">
                        <span class="ar">ارفع جميع فواتيرك من أي مجلد - سيقوم الذكاء الاصطناعي بتصنيفها تلقائياً وتوزيعها على الفئات المناسبة</span>
                        <span class="en">Upload all your invoices from any folder - AI will automatically categorize and distribute them to appropriate pools</span>
                    </p>
                </div>
            </div>
            
            <!-- Bulk Upload Zone -->
            <div class="bulk-upload-zone" id="bulk-upload-zone">
                <input type="file" id="bulk-file-input" multiple accept="image/*,.pdf" style="display:none;">
                <div class="bulk-upload-icon">
                    <i data-lucide="folder-up" class="icon icon-4xl"></i>
                </div>
                <div class="bulk-upload-text">
                    <span class="ar">اسحب جميع الفواتير هنا أو انقر للاختيار</span>
                    <span class="en">Drag all invoices here or click to select</span>
                </div>
                <div class="bulk-upload-hint">
                    <span class="ar">فواتير موردين، إيصالات إيجار، كشوف رواتب، فواتير خدمات - كلها معاً!</span>
                    <span class="en">Supplier invoices, rent receipts, payroll, utility bills - all together!</span>
                </div>
                <div class="bulk-upload-formats">
                    <span class="format-badge">PDF</span>
                    <span class="format-badge">PNG</span>
                    <span class="format-badge">JPG</span>
                    <span class="format-badge"><span class="ar">حد أقصى 20 ملف</span><span class="en">Max 20 files</span></span>
                </div>
            </div>
            
            <!-- Files Preview -->
            <div class="bulk-files-preview" id="bulk-files-preview">
                <div class="files-header">
                    <div class="files-count">
                        <i data-lucide="files" class="icon"></i>
                        <span class="ar">الملفات المرفوعة</span>
                        <span class="en">Uploaded Files</span>
                        <span class="count-badge" id="bulk-files-count">0</span>
                    </div>
                    <button class="files-clear" id="bulk-files-clear">
                        <i data-lucide="trash-2" class="icon icon-sm"></i>
                        <span class="ar">مسح الكل</span>
                        <span class="en">Clear All</span>
                    </button>
                </div>
                <div class="files-grid" id="bulk-files-grid"></div>
            </div>
            
            <!-- Categorize Button -->
            <button class="categorize-btn" id="categorize-btn" disabled>
                <i data-lucide="brain" class="icon icon-lg"></i>
                <span class="ar">تصنيف تلقائي بالذكاء الاصطناعي</span>
                <span class="en">Auto-Categorize with AI</span>
            </button>
            
            <!-- AI Categorization Engine Animation -->
            <div class="ai-categorization-engine" id="ai-categorization-engine">
                <div class="engine-header">
                    <div class="engine-avatar">
                        <span>م</span>
                        <div class="engine-avatar-ring"></div>
                    </div>
                    <div class="engine-status">
                        <div class="engine-status-text" id="engine-status-text">
                            <span class="ar">جاري تحليل الفواتير...</span>
                            <span class="en">Analyzing invoices...</span>
                        </div>
                        <div class="engine-status-detail" id="engine-status-detail">
                            <span class="ar">قراءة محتوى الملفات</span>
                            <span class="en">Reading file contents</span>
                        </div>
                    </div>
                </div>
                
                <div class="categorization-steps">
                    <div class="cat-step" id="cat-step-1">
                        <div class="cat-step-icon">
                            <i data-lucide="scan-text" class="icon"></i>
                        </div>
                        <div class="cat-step-label">
                            <span class="ar">قراءة OCR</span>
                            <span class="en">OCR Reading</span>
                        </div>
                    </div>
                    <div class="cat-step" id="cat-step-2">
                        <div class="cat-step-icon">
                            <i data-lucide="brain" class="icon"></i>
                        </div>
                        <div class="cat-step-label">
                            <span class="ar">تحليل AI</span>
                            <span class="en">AI Analysis</span>
                        </div>
                    </div>
                    <div class="cat-step" id="cat-step-3">
                        <div class="cat-step-icon">
                            <i data-lucide="tags" class="icon"></i>
                        </div>
                        <div class="cat-step-label">
                            <span class="ar">تصنيف</span>
                            <span class="en">Categorizing</span>
                        </div>
                    </div>
                    <div class="cat-step" id="cat-step-4">
                        <div class="cat-step-icon">
                            <i data-lucide="calculator" class="icon"></i>
                        </div>
                        <div class="cat-step-label">
                            <span class="ar">استخراج البيانات</span>
                            <span class="en">Data Extraction</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Categorization Results -->
            <div class="categorization-results" id="categorization-results">
                <div class="results-header">
                    <div class="results-title">
                        <i data-lucide="check-circle" class="icon icon-lg"></i>
                        <span class="ar">تم التصنيف بنجاح!</span>
                        <span class="en">Categorization Complete!</span>
                    </div>
                    <div class="results-summary" id="results-summary"></div>
                </div>
                
                <div class="results-categories">
                    <!-- Suppliers Results -->
                    <div class="result-category" id="result-cat-suppliers">
                        <div class="result-category-header">
                            <div class="result-cat-icon suppliers">
                                <i data-lucide="truck" class="icon"></i>
                            </div>
                            <div class="result-cat-title">
                                <span class="ar">فواتير الموردين</span>
                                <span class="en">Supplier Invoices</span>
                            </div>
                            <div class="result-cat-count" id="result-count-suppliers">0</div>
                        </div>
                        <div class="result-cat-items" id="result-items-suppliers"></div>
                        <div class="empty-message">
                            <span class="ar">لا توجد فواتير موردين</span>
                            <span class="en">No supplier invoices</span>
                        </div>
                        <div class="result-cat-total">
                            <span class="result-cat-total-label">
                                <span class="ar">الإجمالي</span>
                                <span class="en">Total</span>
                            </span>
                            <span class="result-cat-total-value" id="result-total-suppliers">0 SAR</span>
                        </div>
                    </div>
                    
                    <!-- Salaries Results -->
                    <div class="result-category" id="result-cat-salaries">
                        <div class="result-category-header">
                            <div class="result-cat-icon salaries">
                                <i data-lucide="users" class="icon"></i>
                            </div>
                            <div class="result-cat-title">
                                <span class="ar">الرواتب والأجور</span>
                                <span class="en">Salaries & Wages</span>
                            </div>
                            <div class="result-cat-count" id="result-count-salaries">0</div>
                        </div>
                        <div class="result-cat-items" id="result-items-salaries"></div>
                        <div class="empty-message">
                            <span class="ar">لا توجد كشوف رواتب</span>
                            <span class="en">No payroll records</span>
                        </div>
                        <div class="result-cat-total">
                            <span class="result-cat-total-label">
                                <span class="ar">الإجمالي</span>
                                <span class="en">Total</span>
                            </span>
                            <span class="result-cat-total-value" id="result-total-salaries">0 SAR</span>
                        </div>
                    </div>
                    
                    <!-- Rent Results -->
                    <div class="result-category" id="result-cat-rent">
                        <div class="result-category-header">
                            <div class="result-cat-icon rent">
                                <i data-lucide="home" class="icon"></i>
                            </div>
                            <div class="result-cat-title">
                                <span class="ar">الإيجار</span>
                                <span class="en">Rent</span>
                            </div>
                            <div class="result-cat-count" id="result-count-rent">0</div>
                        </div>
                        <div class="result-cat-items" id="result-items-rent"></div>
                        <div class="empty-message">
                            <span class="ar">لا توجد إيصالات إيجار</span>
                            <span class="en">No rent receipts</span>
                        </div>
                        <div class="result-cat-total">
                            <span class="result-cat-total-label">
                                <span class="ar">الإجمالي</span>
                                <span class="en">Total</span>
                            </span>
                            <span class="result-cat-total-value" id="result-total-rent">0 SAR</span>
                        </div>
                    </div>
                    
                    <!-- Misc Results -->
                    <div class="result-category" id="result-cat-misc">
                        <div class="result-category-header">
                            <div class="result-cat-icon misc">
                                <i data-lucide="more-horizontal" class="icon"></i>
                            </div>
                            <div class="result-cat-title">
                                <span class="ar">مصاريف أخرى</span>
                                <span class="en">Miscellaneous</span>
                            </div>
                            <div class="result-cat-count" id="result-count-misc">0</div>
                        </div>
                        <div class="result-cat-items" id="result-items-misc"></div>
                        <div class="empty-message">
                            <span class="ar">لا توجد مصاريف أخرى</span>
                            <span class="en">No misc expenses</span>
                        </div>
                        <div class="result-cat-total">
                            <span class="result-cat-total-label">
                                <span class="ar">الإجمالي</span>
                                <span class="en">Total</span>
                            </span>
                            <span class="result-cat-total-value" id="result-total-misc">0 SAR</span>
                        </div>
                    </div>
                </div>
                
                <button class="apply-results-btn" id="apply-results-btn">
                    <i data-lucide="check-check" class="icon icon-lg"></i>
                    <span class="ar">تطبيق التصنيف وتحديث الحسابات</span>
                    <span class="en">Apply Categorization & Update Accounts</span>
                </button>
            </div>
            
            <!-- Success State -->
            <div class="categorization-success" id="categorization-success">
                <div class="success-icon">
                    <i data-lucide="check-circle" class="icon icon-3xl icon-emerald"></i>
                </div>
                <div class="success-title">
                    <span class="ar">تم تطبيق التصنيف بنجاح!</span>
                    <span class="en">Categorization Applied Successfully!</span>
                </div>
                <div class="success-message">
                    <span class="ar">تم توزيع جميع الفواتير على الفئات المناسبة وتحديث الحسابات</span>
                    <span class="en">All invoices have been distributed to appropriate categories and accounts updated</span>
                </div>
            </div>
        </div>
        
        <!-- Two Column Layout: Sales vs Expenses -->
        <div class="accounting-grid">
            <!-- LEFT: Sales Dashboard -->
            <div class="accounting-panel sales-panel">
                <div class="panel-header">
                    <div class="panel-icon sales">
                        <i data-lucide="trending-up" class="icon icon-xl"></i>
                    </div>
                    <div>
                        <div class="panel-label"><span class="ar">الخطوة ٤</span><span class="en">Step 4</span></div>
                        <div class="panel-title"><span class="ar">إجمالي المبيعات</span><span class="en">Total Sales</span></div>
                    </div>
                    <div class="panel-status">
                        <span class="status-badge waiting" id="sales-status">
                            <span class="ar">ارفع الفواتير</span>
                            <span class="en">Upload Invoices</span>
                        </span>
                    </div>
                </div>
                
                <div class="panel-content">
                    <!-- Sales Summary Cards -->
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="file-text" class="icon"></i></div>
                            <div class="summary-value" id="total-invoices">0</div>
                            <div class="summary-label"><span class="ar">الفواتير</span><span class="en">Invoices</span></div>
                        </div>
                        <div class="summary-card highlight">
                            <div class="summary-icon"><i data-lucide="saudi-riyal" class="icon"></i></div>
                            <div class="summary-value" id="total-sales">0</div>
                            <div class="summary-label"><span class="ar">المبيعات</span><span class="en">Sales (SAR)</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-icon"><i data-lucide="percent" class="icon"></i></div>
                            <div class="summary-value" id="output-vat">0</div>
                            <div class="summary-label"><span class="ar">ضريبة المخرجات</span><span class="en">Output VAT</span></div>
                        </div>
                    </div>
                    
                    <!-- Bulk Sales Upload -->
                    <div class="sales-bulk-upload">
                        <div class="sales-upload-zone" id="sales-upload-zone">
                            <input type="file" id="sales-file-input" multiple accept="image/*,.pdf" style="display:none;">
                            <div class="sales-upload-icon">
                                <i data-lucide="upload-cloud" class="icon icon-xl icon-emerald"></i>
                            </div>
                            <div class="sales-upload-text">
                                <span class="ar">ارفع فواتير المبيعات دفعة واحدة</span>
                                <span class="en">Upload multiple sales invoices at once</span>
                            </div>
                            <div class="sales-upload-hint">
                                <span class="ar">اسحب الملفات هنا أو انقر للاختيار (حد أقصى 10 ملفات)</span>
                                <span class="en">Drag files here or click to select (max 10 files)</span>
                            </div>
                        </div>
                        
                        <div class="sales-files-preview" id="sales-files-preview">
                            <div class="sales-files-header">
                                <span class="sales-files-count" id="sales-files-count">0 <span class="ar">ملفات</span><span class="en">files</span></span>
                                <button class="sales-files-clear" id="sales-files-clear">
                                    <span class="ar">مسح الكل</span><span class="en">Clear all</span>
                                </button>
                            </div>
                            <div class="sales-files-list" id="sales-files-list"></div>
                        </div>
                        
                        <button class="process-sales-btn" id="process-sales-btn" disabled>
                            <i data-lucide="zap" class="icon"></i>
                            <span class="ar">معالجة الفواتير عبر زاتكا</span>
                            <span class="en">Process Invoices via ZATCA</span>
                        </button>
                    </div>
                    
                    <div class="sales-divider">
                        <div class="sales-divider-line"></div>
                        <span class="sales-divider-text"><span class="ar">أو</span><span class="en">or</span></span>
                        <div class="sales-divider-line"></div>
                    </div>
                    
                    <!-- Invoice List -->
                    <div class="invoice-list">
                        <div class="list-header">
                            <span><span class="ar">الفواتير الصادرة</span><span class="en">Issued Invoices</span></span>
                            <span class="list-count" id="invoice-list-count">0</span>
                        </div>
                        <div class="invoice-items" id="invoice-items">
                            <div class="invoice-empty-state" id="invoice-empty-state">
                                <i data-lucide="inbox" class="icon icon-xl" style="color:#64748b; margin-bottom:0.5rem;"></i>
                                <p style="color:#64748b; font-size:0.85rem;">
                                    <span class="ar">لا توجد فواتير - ارفع فواتيرك أعلاه</span>
                                    <span class="en">No invoices yet - upload yours above</span>
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add More Invoices Button -->
                    <button class="add-invoice-btn" onclick="addSampleInvoice()">
                        <i data-lucide="plus-circle" class="icon"></i>
                        <span class="ar">إضافة فاتورة تجريبية</span>
                        <span class="en">Add Sample Invoice</span>
                    </button>
                </div>
            </div>
            
            <!-- RIGHT: Expenses Upload -->
            <div class="accounting-panel expenses-panel">
                <div class="panel-header">
                    <div class="panel-icon expenses">
                        <i data-lucide="receipt" class="icon icon-xl"></i>
                    </div>
                    <div>
                        <div class="panel-label"><span class="ar">الخطوة ٥</span><span class="en">Step 5</span></div>
                        <div class="panel-title"><span class="ar">تكاليف المدخلات</span><span class="en">Input Costs</span></div>
                    </div>
                    <div class="panel-status">
                        <span class="status-badge waiting" id="expenses-status">
                            <span class="ar">أضف المصاريف</span>
                            <span class="en">Add Expenses</span>
                        </span>
                    </div>
                </div>
                
                <div class="panel-content">
                    <!-- Expense Categories -->
                    <div class="expense-categories">
                        <!-- Supplier Invoices -->
                        <div class="expense-category" id="cat-suppliers">
                            <div class="category-header" onclick="toggleExpenseUpload('suppliers')">
                                <div class="category-icon suppliers">
                                    <i data-lucide="truck" class="icon"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-title"><span class="ar">فواتير الموردين</span><span class="en">Supplier Invoices</span></div>
                                    <div class="category-hint"><span class="ar">مواد، بضائع، مخزون</span><span class="en">Materials, goods, inventory</span></div>
                                </div>
                                <div class="category-amount" id="suppliers-amount">0 SAR</div>
                                <i data-lucide="chevron-down" class="icon category-chevron"></i>
                            </div>
                            <div class="category-upload" id="upload-suppliers">
                                <div class="mini-upload-zone" onclick="triggerExpenseUpload('suppliers')">
                                    <i data-lucide="upload" class="icon"></i>
                                    <span><span class="ar">ارفع الفواتير</span><span class="en">Upload invoices</span></span>
                                </div>
                                <input type="file" id="input-suppliers" accept="image/*,.pdf" multiple onchange="handleExpenseUpload('suppliers', this.files)">
                                <div class="uploaded-expenses" id="expenses-suppliers"></div>
                            </div>
                        </div>
                        
                        <!-- Salaries -->
                        <div class="expense-category" id="cat-salaries">
                            <div class="category-header" onclick="toggleExpenseUpload('salaries')">
                                <div class="category-icon salaries">
                                    <i data-lucide="users" class="icon"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-title"><span class="ar">الرواتب والأجور</span><span class="en">Salaries & Wages</span></div>
                                    <div class="category-hint"><span class="ar">موظفين، عمالة</span><span class="en">Employees, labor</span></div>
                                </div>
                                <div class="category-amount" id="salaries-amount">0 SAR</div>
                                <i data-lucide="chevron-down" class="icon category-chevron"></i>
                            </div>
                            <div class="category-upload" id="upload-salaries">
                                <div class="mini-upload-zone" onclick="triggerExpenseUpload('salaries')">
                                    <i data-lucide="upload" class="icon"></i>
                                    <span><span class="ar">ارفع كشف الرواتب</span><span class="en">Upload payroll</span></span>
                                </div>
                                <input type="file" id="input-salaries" accept="image/*,.pdf" multiple onchange="handleExpenseUpload('salaries', this.files)">
                                <div class="uploaded-expenses" id="expenses-salaries"></div>
                            </div>
                        </div>
                        
                        <!-- Rent -->
                        <div class="expense-category" id="cat-rent">
                            <div class="category-header" onclick="toggleExpenseUpload('rent')">
                                <div class="category-icon rent">
                                    <i data-lucide="home" class="icon"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-title"><span class="ar">الإيجار</span><span class="en">Rent</span></div>
                                    <div class="category-hint"><span class="ar">مكتب، محل، مستودع</span><span class="en">Office, shop, warehouse</span></div>
                                </div>
                                <div class="category-amount" id="rent-amount">0 SAR</div>
                                <i data-lucide="chevron-down" class="icon category-chevron"></i>
                            </div>
                            <div class="category-upload" id="upload-rent">
                                <div class="mini-upload-zone" onclick="triggerExpenseUpload('rent')">
                                    <i data-lucide="upload" class="icon"></i>
                                    <span><span class="ar">ارفع عقد/إيصال الإيجار</span><span class="en">Upload rent receipt</span></span>
                                </div>
                                <input type="file" id="input-rent" accept="image/*,.pdf" multiple onchange="handleExpenseUpload('rent', this.files)">
                                <div class="uploaded-expenses" id="expenses-rent"></div>
                            </div>
                        </div>
                        
                        <!-- Miscellaneous -->
                        <div class="expense-category" id="cat-misc">
                            <div class="category-header" onclick="toggleExpenseUpload('misc')">
                                <div class="category-icon misc">
                                    <i data-lucide="more-horizontal" class="icon"></i>
                                </div>
                                <div class="category-info">
                                    <div class="category-title"><span class="ar">مصاريف أخرى</span><span class="en">Miscellaneous</span></div>
                                    <div class="category-hint"><span class="ar">كهرباء، ماء، اتصالات، صيانة</span><span class="en">Utilities, maintenance, etc.</span></div>
                                </div>
                                <div class="category-amount" id="misc-amount">0 SAR</div>
                                <i data-lucide="chevron-down" class="icon category-chevron"></i>
                            </div>
                            <div class="category-upload" id="upload-misc">
                                <div class="mini-upload-zone" onclick="triggerExpenseUpload('misc')">
                                    <i data-lucide="upload" class="icon"></i>
                                    <span><span class="ar">ارفع الفواتير</span><span class="en">Upload receipts</span></span>
                                </div>
                                <input type="file" id="input-misc" accept="image/*,.pdf" multiple onchange="handleExpenseUpload('misc', this.files)">
                                <div class="uploaded-expenses" id="expenses-misc"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Add Buttons -->
                    <div class="quick-add-section">
                        <div class="quick-add-label"><span class="ar">إضافة سريعة (تجريبي)</span><span class="en">Quick Add (Demo)</span></div>
                        <div class="quick-add-buttons">
                            <button class="quick-add-btn" onclick="addQuickExpense('suppliers', 'فاتورة مورد', 'Supplier Invoice', 5000)">
                                <i data-lucide="truck" class="icon"></i>
                                <span>5,000</span>
                            </button>
                            <button class="quick-add-btn" onclick="addQuickExpense('salaries', 'راتب موظف', 'Employee Salary', 4500)">
                                <i data-lucide="users" class="icon"></i>
                                <span>4,500</span>
                            </button>
                            <button class="quick-add-btn" onclick="addQuickExpense('rent', 'إيجار شهري', 'Monthly Rent', 3000)">
                                <i data-lucide="home" class="icon"></i>
                                <span>3,000</span>
                            </button>
                            <button class="quick-add-btn" onclick="addQuickExpense('misc', 'كهرباء', 'Electricity', 800)">
                                <i data-lucide="zap" class="icon"></i>
                                <span>800</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- AI Processing Animation for Expenses -->
        <div class="ai-expense-processor" id="ai-expense-processor" style="display:none;">
            <div class="processor-content">
                <div class="processor-avatar">
                    <span>م</span>
                    <div class="processor-ring"></div>
                </div>
                <div class="processor-text">
                    <span class="ar" id="processor-text-ar">جاري تحليل المصروفات...</span>
                    <span class="en" id="processor-text-en">Analyzing expenses...</span>
                </div>
            </div>
        </div>
        
        <!-- ============================================== -->
        <!-- RECONCILIATION & FINANCIAL REPORT SECTION -->
        <!-- ============================================== -->
        <div class="reconciliation-section" id="reconciliation-section">
            <div class="reconciliation-header">
                <div class="recon-badge">
                    <i data-lucide="calculator" class="icon icon-sm"></i>
                    <span class="ar">التسوية التلقائية</span>
                    <span class="en">Auto Reconciliation</span>
                </div>
            </div>
            
            <!-- VAT Reconciliation -->
            <div class="vat-reconciliation">
                <div class="vat-card output">
                    <div class="vat-card-header">
                        <i data-lucide="arrow-up-circle" class="icon"></i>
                        <span><span class="ar">ضريبة المخرجات</span><span class="en">Output VAT</span></span>
                    </div>
                    <div class="vat-card-value" id="recon-output-vat">0</div>
                    <div class="vat-card-label"><span class="ar">مستحقة للهيئة</span><span class="en">Collected from customers</span></div>
                </div>
                
                <div class="vat-operator">
                    <span>−</span>
                </div>
                
                <div class="vat-card input">
                    <div class="vat-card-header">
                        <i data-lucide="arrow-down-circle" class="icon"></i>
                        <span><span class="ar">ضريبة المدخلات</span><span class="en">Input VAT</span></span>
                    </div>
                    <div class="vat-card-value" id="recon-input-vat">0</div>
                    <div class="vat-card-label"><span class="ar">مدفوعة على المصاريف</span><span class="en">Paid on expenses</span></div>
                </div>
                
                <div class="vat-operator">
                    <span>=</span>
                </div>
                
                <div class="vat-card net" id="vat-net-card">
                    <div class="vat-card-header">
                        <i data-lucide="wallet" class="icon"></i>
                        <span><span class="ar">صافي الضريبة</span><span class="en">Net VAT</span></span>
                    </div>
                    <div class="vat-card-value" id="recon-net-vat">0</div>
                    <div class="vat-card-label" id="vat-net-label">
                        <span class="ar">مستحق للهيئة</span>
                        <span class="en">Payable to ZATCA</span>
                    </div>
                </div>
            </div>
            
            <!-- Financial Summary -->
            <div class="financial-summary">
                <h3 class="summary-title">
                    <i data-lucide="bar-chart-3" class="icon"></i>
                    <span class="ar">ملخص الأرباح والخسائر</span>
                    <span class="en">Profit & Loss Summary</span>
                </h3>
                
                <div class="pnl-grid">
                    <div class="pnl-item revenue">
                        <div class="pnl-label"><span class="ar">إجمالي الإيرادات</span><span class="en">Total Revenue</span></div>
                        <div class="pnl-value" id="pnl-revenue">0</div>
                    </div>
                    <div class="pnl-item expenses">
                        <div class="pnl-label"><span class="ar">إجمالي المصاريف</span><span class="en">Total Expenses</span></div>
                        <div class="pnl-value" id="pnl-expenses">0</div>
                    </div>
                    <div class="pnl-item profit" id="pnl-profit-item">
                        <div class="pnl-label"><span class="ar">صافي الربح</span><span class="en">Net Profit</span></div>
                        <div class="pnl-value" id="pnl-profit">0</div>
                    </div>
                    <div class="pnl-item margin">
                        <div class="pnl-label"><span class="ar">هامش الربح</span><span class="en">Profit Margin</span></div>
                        <div class="pnl-value" id="pnl-margin">0%</div>
                    </div>
                </div>
                
                <!-- Expense Breakdown -->
                <div class="expense-breakdown" id="expense-breakdown" style="display:none;">
                    <h4 class="breakdown-title">
                        <i data-lucide="pie-chart" class="icon icon-sm"></i>
                        <span class="ar">تفصيل المصاريف</span>
                        <span class="en">Expense Breakdown</span>
                    </h4>
                    <div class="breakdown-bars">
                        <div class="breakdown-item" id="breakdown-suppliers" style="display:none;">
                            <div class="breakdown-label"><span class="ar">موردين</span><span class="en">Suppliers</span></div>
                            <div class="breakdown-bar"><div class="breakdown-fill suppliers" id="bar-suppliers" style="width:0%"></div></div>
                            <div class="breakdown-value" id="breakdown-suppliers-value">0</div>
                        </div>
                        <div class="breakdown-item" id="breakdown-salaries" style="display:none;">
                            <div class="breakdown-label"><span class="ar">رواتب</span><span class="en">Salaries</span></div>
                            <div class="breakdown-bar"><div class="breakdown-fill salaries" id="bar-salaries" style="width:0%"></div></div>
                            <div class="breakdown-value" id="breakdown-salaries-value">0</div>
                        </div>
                        <div class="breakdown-item" id="breakdown-rent" style="display:none;">
                            <div class="breakdown-label"><span class="ar">إيجار</span><span class="en">Rent</span></div>
                            <div class="breakdown-bar"><div class="breakdown-fill rent" id="bar-rent" style="width:0%"></div></div>
                            <div class="breakdown-value" id="breakdown-rent-value">0</div>
                        </div>
                        <div class="breakdown-item" id="breakdown-misc" style="display:none;">
                            <div class="breakdown-label"><span class="ar">أخرى</span><span class="en">Other</span></div>
                            <div class="breakdown-bar"><div class="breakdown-fill misc" id="bar-misc" style="width:0%"></div></div>
                            <div class="breakdown-value" id="breakdown-misc-value">0</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Generate Report Button -->
            <div class="report-actions">
                <button class="report-btn" onclick="generateFinancialReport()">
                    <i data-lucide="file-spreadsheet" class="icon"></i>
                    <span class="ar">تحميل التقرير المالي</span>
                    <span class="en">Download Financial Report</span>
                </button>
                <button class="report-btn secondary" onclick="generateVATReport()">
                    <i data-lucide="file-text" class="icon"></i>
                    <span class="ar">تقرير الضريبة</span>
                    <span class="en">VAT Report</span>
                </button>
            </div>
        </div>
    </div>
</main>

<script>
// Language Toggle
function setLang(lang) {
    const html = document.getElementById('html-root');
    const btnAr = document.getElementById('btn-ar');
    const btnEn = document.getElementById('btn-en');
    
    if (lang === 'ar') {
        html.setAttribute('dir', 'rtl');
        html.setAttribute('lang', 'ar');
        btnAr.classList.add('active');
        btnEn.classList.remove('active');
    } else {
        html.setAttribute('dir', 'ltr');
        html.setAttribute('lang', 'en');
        btnEn.classList.add('active');
        btnAr.classList.remove('active');
    }
}

// File Upload Handling
const uploadZone = document.getElementById('upload-zone');
const fileInput = document.getElementById('file-input');
const filePreview = document.getElementById('file-preview');
const fileNameEl = document.getElementById('file-name');
const fileSizeEl = document.getElementById('file-size');
const invoicePreview = document.getElementById('invoice-preview');
const fileRemove = document.getElementById('file-remove');
const processBtn = document.getElementById('process-btn');

let uploadedFile = null;

// Click to upload
uploadZone.addEventListener('click', () => {
    if (!uploadZone.classList.contains('has-file')) {
        fileInput.click();
    }
});

// Drag and drop
uploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadZone.classList.add('drag-over');
});

uploadZone.addEventListener('dragleave', () => {
    uploadZone.classList.remove('drag-over');
});

uploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadZone.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        handleFile(files[0]);
    }
});

// File input change
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFile(e.target.files[0]);
    }
});

// Handle file
function handleFile(file) {
    // Validate file type
    const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
    if (!validTypes.includes(file.type)) {
        alert(isArabic() ? 'نوع الملف غير مدعوم' : 'File type not supported');
        return;
    }
    
    // Validate file size (10MB max)
    if (file.size > 10 * 1024 * 1024) {
        alert(isArabic() ? 'حجم الملف كبير جداً (الحد الأقصى 10MB)' : 'File too large (max 10MB)');
        return;
    }
    
    uploadedFile = file;
    fileNameEl.textContent = file.name;
    fileSizeEl.textContent = formatFileSize(file.size);
    
    // Show preview
    uploadZone.style.display = 'none';
    filePreview.classList.add('show');
    
    // Update status
    updateStatus('business', 'success', isArabic() ? 'تم رفع الفاتورة' : 'Invoice uploaded');
    document.getElementById('card-business').classList.add('completed');
    
    // Preview image or show PDF placeholder
    if (file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = (e) => {
            invoicePreview.innerHTML = `<img src="${e.target.result}" alt="Invoice Preview">`;
        };
        reader.readAsDataURL(file);
    } else {
        invoicePreview.innerHTML = `
            <div class="pdf-placeholder">
                <i data-lucide="file-text" class="icon icon-3xl" style="color:#a78bfa;"></i>
                <p style="margin-top:0.5rem;font-size:0.8rem;color:#a78bfa;">${file.name}</p>
            </div>
        `;
        lucide.createIcons();
    }
    
    lucide.createIcons();
}

// Remove file
fileRemove.addEventListener('click', (e) => {
    e.stopPropagation();
    resetUpload();
});

function resetUpload() {
    uploadedFile = null;
    fileInput.value = '';
    uploadZone.style.display = 'flex';
    filePreview.classList.remove('show');
    updateStatus('business', 'waiting', isArabic() ? 'في انتظار الفاتورة' : 'Waiting for invoice');
    document.getElementById('card-business').classList.remove('completed');
}

// Process button click - Start the flow
processBtn.addEventListener('click', startProcessing);

async function startProcessing() {
    if (!uploadedFile) return;
    
    console.log('Starting processing...');
    processBtn.disabled = true;
    processBtn.innerHTML = `<span class="spinner"></span> <span class="ar">جاري الإرسال...</span><span class="en">Sending...</span>`;
    
    // Activate arrow 1
    document.getElementById('arrow-1').classList.add('active');
    
    try {
        // Start AI processing
        console.log('Starting AI processing...');
        await processWithAI();
        console.log('AI processing complete');
        
        // Reset button after completion
        processBtn.innerHTML = `<i data-lucide="check-circle" class="icon"></i><span class="ar">تم الإرسال</span><span class="en">Sent Successfully</span>`;
        processBtn.style.background = 'linear-gradient(to right, #34d399, #22d3d1)';
        lucide.createIcons();
    } catch (error) {
        console.error('Processing error:', error);
        processBtn.disabled = false;
        processBtn.innerHTML = `<i data-lucide="alert-circle" class="icon"></i><span class="ar">حدث خطأ - حاول مجدداً</span><span class="en">Error - Try Again</span>`;
        processBtn.style.background = '#ef4444';
        lucide.createIcons();
    }
}

async function processWithAI() {
    console.log('processWithAI started');
    const aiCard = document.getElementById('card-ai');
    const aiAgent = document.getElementById('ai-agent');
    
    if (!aiCard || !aiAgent) {
        throw new Error('AI card elements not found');
    }
    
    aiCard.classList.add('active');
    aiAgent.classList.add('processing');
    updateStatus('ai', 'processing', isArabic() ? 'جاري المعالجة' : 'Processing');
    
    // Update AI message
    updateAIMessage(isArabic() ? 'أقوم الآن بقراءة بيانات الفاتورة...' : 'Reading invoice data...');
    
    // Step 1: Reading invoice
    console.log('Step 1');
    await animateStep(1, 1500);
    updateAIMessage(isArabic() ? 'التحقق من متطلبات زاتكا...' : 'Validating ZATCA requirements...');
    
    // Step 2: Validating
    console.log('Step 2');
    await animateStep(2, 1200);
    updateAIMessage(isArabic() ? 'حساب ضريبة القيمة المضافة...' : 'Calculating VAT...');
    
    // Step 3: Calculating VAT
    console.log('Step 3');
    await animateStep(3, 1000);
    updateAIMessage(isArabic() ? 'إرسال الفاتورة إلى بوابة زاتكا...' : 'Sending invoice to ZATCA portal...');
    
    // Step 4: Sending to ZATCA
    console.log('Step 4');
    await animateStep(4, 800);
    
    // Activate arrow 2
    document.getElementById('arrow-2').classList.add('active');
    
    // Complete AI processing
    aiAgent.classList.remove('processing');
    aiCard.classList.remove('active');
    aiCard.classList.add('completed');
    updateStatus('ai', 'success', isArabic() ? 'اكتملت المعالجة' : 'Processing complete');
    updateAIMessage(isArabic() ? 'تم إرسال الفاتورة بنجاح!' : 'Invoice sent successfully!');
    
    console.log('Calling processZATCA');
    // Start ZATCA processing
    await processZATCA();
    console.log('processZATCA complete');
}

async function animateStep(stepNum, delay) {
    const step = document.getElementById(`step-${stepNum}`);
    step.classList.add('active');
    
    // Add spinner to active step
    const icon = step.querySelector('.step-icon');
    icon.innerHTML = '<span class="spinner" style="width:14px;height:14px;"></span>';
    
    await sleep(delay);
    
    step.classList.remove('active');
    step.classList.add('completed');
    icon.innerHTML = '<i data-lucide="check" class="icon icon-sm"></i>';
    lucide.createIcons();
}

async function processZATCA() {
    const zatcaCard = document.getElementById('card-zatca');
    zatcaCard.classList.add('active');
    updateStatus('zatca', 'processing', isArabic() ? 'جاري التحقق' : 'Verifying');
    
    // Hide waiting, show validation
    await sleep(800);
    document.getElementById('zatca-waiting').style.display = 'none';
    document.getElementById('validation-result').classList.add('show');
    
    // Animate validation results
    const results = document.querySelectorAll('.result-item');
    for (let i = 0; i < results.length; i++) {
        results[i].classList.add('animate-in');
        await sleep(500);
    }
    
    await sleep(800);
    
    // Show approved invoice
    document.getElementById('approved-invoice').classList.add('show');
    
    // Generate random ZATCA ID
    const zatcaId = generateZATCAId();
    document.getElementById('zatca-id').textContent = zatcaId;
    
    // Complete ZATCA
    zatcaCard.classList.remove('active');
    zatcaCard.classList.add('completed');
    updateStatus('zatca', 'success', isArabic() ? 'تمت الموافقة' : 'Approved');
    
    // Show customer delivery options
    await sleep(500);
    document.getElementById('customer-delivery').classList.add('show');
    
    // Show reset section
    document.getElementById('reset-section').style.display = 'block';
    
    lucide.createIcons();
}

// Open invoice in new window with action buttons
function deliverInvoice(method) {
    openInvoiceWindow(method);
}

// Open invoice window with all sharing options
function openInvoiceWindow(highlightMethod = null) {
    const zatcaId = document.getElementById('zatca-id').textContent;
    const fileName = uploadedFile ? uploadedFile.name : 'invoice';
    const approvalDate = new Date().toLocaleDateString('en-CA');
    const approvalTime = new Date().toLocaleTimeString('en-US', { hour12: false });
    
    const invoiceHTML = generateInvoiceWithActions(zatcaId, fileName, approvalDate, approvalTime, highlightMethod);
    
    const invoiceWindow = window.open('', '_blank', 'width=900,height=800');
    if (invoiceWindow) {
        invoiceWindow.document.write(invoiceHTML);
        invoiceWindow.document.close();
        // Focus the window to ensure it's visible
        invoiceWindow.focus();
    }
}

// Generate complete invoice HTML with action buttons
function generateInvoiceWithActions(zatcaId, fileName, approvalDate, approvalTime, highlightMethod) {
    const isRTL = isArabic();
    const align = isRTL ? 'right' : 'left';
    const alignOpp = isRTL ? 'left' : 'right';
    
    const emailSubject = encodeURIComponent(isRTL ? `فاتورة معتمدة من زاتكا - ${zatcaId}` : `ZATCA Approved Invoice - ${zatcaId}`);
    const emailBody = encodeURIComponent(isRTL 
        ? `مرحباً،\n\nمرفق فاتورتكم المعتمدة من زاتكا.\n\nرقم الفاتورة: ${zatcaId}\nتاريخ الاعتماد: ${approvalDate}\nالحالة: ✓ معتمدة\n\nيرجى حفظ الفاتورة كـ PDF وإرفاقها.\n\nشكراً لتعاملكم معنا!`
        : `Hello,\n\nPlease find your ZATCA approved invoice.\n\nInvoice ID: ${zatcaId}\nApproval Date: ${approvalDate}\nStatus: ✓ Approved\n\nPlease save the invoice as PDF and attach it.\n\nThank you for your business!`);
    
    const whatsappMsg = encodeURIComponent(isRTL
        ? `مرحباً،\n\nمرفق فاتورتكم المعتمدة من زاتكا.\n\nرقم الفاتورة: ${zatcaId}\nتاريخ الاعتماد: ${approvalDate}\nالحالة: ✓ معتمدة\n\nيرجى حفظ الفاتورة كـ PDF من المتصفح وإرفاقها.`
        : `Hello,\n\nPlease find your ZATCA approved invoice.\n\nInvoice ID: ${zatcaId}\nApproval Date: ${approvalDate}\nStatus: ✓ Approved\n\nPlease save invoice as PDF from browser and attach.`);

    return `<!DOCTYPE html>
<html lang="${isRTL ? 'ar' : 'en'}" dir="${isRTL ? 'rtl' : 'ltr'}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${isRTL ? 'فاتورة معتمدة من زاتكا' : 'ZATCA Approved Invoice'} - ${zatcaId}</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: '${isRTL ? 'Tajawal' : 'Inter'}', Arial, sans-serif; background: #f1f5f9; min-height: 100vh; }
        .invoice-container { max-width: 800px; margin: 20px auto; background: white; box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 12px; overflow: hidden; }
        .approved-banner { background: linear-gradient(135deg, #059669, #10b981); color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; }
        .header { background: linear-gradient(135deg, #059669, #10b981); color: white; padding: 25px; display: flex; justify-content: space-between; align-items: flex-start; }
        .company-info h1 { font-size: 1.5rem; margin-bottom: 8px; }
        .company-info p { font-size: 0.9rem; opacity: 0.9; margin: 2px 0; }
        .invoice-title { text-align: ${alignOpp}; }
        .invoice-title h2 { font-size: 1.75rem; }
        .invoice-id { background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 6px; font-size: 0.8rem; margin-top: 10px; display: inline-block; }
        .content { padding: 25px; }
        .zatca-section { border: 2px solid #10b981; border-radius: 12px; padding: 20px; margin-bottom: 25px; background: linear-gradient(135deg, rgba(5,150,105,0.05), rgba(16,185,129,0.1)); display: flex; gap: 20px; }
        .qr-code { width: 100px; height: 100px; background: repeating-conic-gradient(#000 0% 25%, #fff 0% 50%) 50%/8px 8px; border: 1px solid #ccc; border-radius: 8px; flex-shrink: 0; }
        .zatca-details h3 { color: #059669; font-size: 1.1rem; margin-bottom: 15px; }
        .zatca-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #e2e8f0; font-size: 0.9rem; }
        .zatca-row:last-child { border-bottom: none; }
        .zatca-label { color: #64748b; }
        .zatca-value { color: #059669; font-weight: 600; font-family: monospace; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .info-box { background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .info-box h4 { font-size: 0.7rem; text-transform: uppercase; color: #64748b; margin-bottom: 8px; letter-spacing: 0.05em; }
        .info-box .name { font-weight: 700; color: #059669; margin-bottom: 5px; }
        .info-box p { font-size: 0.85rem; margin: 3px 0; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 25px; }
        th { background: #059669; color: white; padding: 12px; text-align: ${align}; font-size: 0.85rem; }
        th:last-child { text-align: ${alignOpp}; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        td:last-child { text-align: ${alignOpp}; }
        tr:nth-child(even) { background: #f8fafc; }
        .totals { margin-${isRTL ? 'right' : 'left'}: auto; width: 280px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; }
        .total-row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 0.9rem; }
        .total-row.grand { border-top: 2px solid #059669; margin-top: 10px; padding-top: 12px; font-size: 1.1rem; font-weight: 700; color: #059669; }
        .footer { background: #f0fdf4; padding: 20px; border-top: 2px solid #10b981; text-align: center; }
        .footer p { color: #059669; font-size: 0.9rem; }
        .verification { font-family: monospace; background: white; padding: 8px 20px; border-radius: 6px; display: inline-block; margin-top: 10px; border: 1px solid #10b981; font-size: 0.85rem; }
        
        /* Action Buttons */
        .action-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e293b; padding: 15px 20px; display: flex; justify-content: center; gap: 15px; box-shadow: 0 -4px 20px rgba(0,0,0,0.2); z-index: 100; }
        .action-btn { display: flex; align-items: center; gap: 8px; padding: 12px 24px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; border: none; transition: all 0.3s; text-decoration: none; }
        .action-btn.pdf { background: #059669; color: white; }
        .action-btn.pdf:hover { background: #047857; transform: translateY(-2px); }
        .action-btn.email { background: #ef4444; color: white; }
        .action-btn.email:hover { background: #dc2626; transform: translateY(-2px); }
        .action-btn.whatsapp { background: #22c55e; color: white; }
        .action-btn.whatsapp:hover { background: #16a34a; transform: translateY(-2px); }
        .action-btn.highlight { animation: pulse 1s ease-in-out 3; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        
        .spacer { height: 100px; }
        
        @media print {
            body { background: white !important; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; color-adjust: exact !important; }
            .action-bar { display: none !important; }
            .spacer { display: none !important; }
            .invoice-container { box-shadow: none !important; margin: 0 !important; border-radius: 0 !important; }
            .approved-banner, .header { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            * { visibility: visible !important; }
        }
        @page { size: A4; margin: 10mm; }
    </style>
</head>
<body>
    <div class="invoice-container" id="invoice-container">
        <div class="approved-banner">✓ ${isRTL ? 'فاتورة معتمدة من هيئة الزكاة والضريبة والجمارك' : 'Invoice Approved by ZATCA'}</div>
        
        <div class="header">
            <div class="company-info">
                <h1>${isRTL ? '🏢 شركة العرض التجريبي' : '🏢 Demo Business Company'}</h1>
                <p>${isRTL ? 'شارع الملك فهد، الرياض 12345' : 'King Fahd Road, Riyadh 12345'}</p>
                <p>${isRTL ? 'هاتف' : 'Phone'}: +966 11 123 4567</p>
                <p style="margin-top:10px;"><strong>${isRTL ? 'الرقم الضريبي' : 'VAT Number'}:</strong> 300123456789012</p>
            </div>
            <div class="invoice-title">
                <h2>${isRTL ? 'فاتورة ضريبية' : 'Tax Invoice'}</h2>
                <div class="invoice-id">${zatcaId}</div>
            </div>
        </div>
        
        <div class="content">
            <div class="zatca-section">
                <div class="qr-code"></div>
                <div class="zatca-details">
                    <h3>🛡️ ${isRTL ? 'بيانات الاعتماد من زاتكا' : 'ZATCA Approval Details'}</h3>
                    <div class="zatca-row"><span class="zatca-label">${isRTL ? 'معرّف الفاتورة' : 'Invoice ID'}</span><span class="zatca-value">${zatcaId}</span></div>
                    <div class="zatca-row"><span class="zatca-label">${isRTL ? 'تاريخ الاعتماد' : 'Approval Date'}</span><span class="zatca-value">${approvalDate}</span></div>
                    <div class="zatca-row"><span class="zatca-label">${isRTL ? 'وقت الاعتماد' : 'Approval Time'}</span><span class="zatca-value">${approvalTime}</span></div>
                    <div class="zatca-row"><span class="zatca-label">${isRTL ? 'الحالة' : 'Status'}</span><span class="zatca-value">✓ ${isRTL ? 'معتمدة' : 'APPROVED'}</span></div>
                </div>
            </div>
            
            <div class="info-grid">
                <div class="info-box">
                    <h4>${isRTL ? 'معلومات العميل' : 'Customer Info'}</h4>
                    <div class="name">${isRTL ? 'شركة العميل للتجارة' : 'Customer Trading Co.'}</div>
                    <p>${isRTL ? 'الرياض، المملكة العربية السعودية' : 'Riyadh, Saudi Arabia'}</p>
                    <p>${isRTL ? 'الرقم الضريبي' : 'VAT'}: 310987654321098</p>
                </div>
                <div class="info-box">
                    <h4>${isRTL ? 'تفاصيل الفاتورة' : 'Invoice Details'}</h4>
                    <p><strong>${isRTL ? 'التاريخ' : 'Date'}:</strong> ${approvalDate}</p>
                    <p><strong>${isRTL ? 'الملف الأصلي' : 'Original File'}:</strong> ${fileName}</p>
                </div>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>${isRTL ? 'الوصف' : 'Description'}</th>
                        <th style="text-align:center;width:80px;">${isRTL ? 'الكمية' : 'Qty'}</th>
                        <th style="text-align:center;width:100px;">${isRTL ? 'السعر' : 'Price'}</th>
                        <th style="width:120px;">${isRTL ? 'المجموع' : 'Total'}</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>${isRTL ? 'خدمات استشارية' : 'Consulting Services'}</td><td style="text-align:center;">1</td><td style="text-align:center;">10,000.00</td><td>10,000.00</td></tr>
                    <tr><td>${isRTL ? 'خدمات تقنية' : 'Technical Services'}</td><td style="text-align:center;">2</td><td style="text-align:center;">2,500.00</td><td>5,000.00</td></tr>
                    <tr><td>${isRTL ? 'دعم فني' : 'Technical Support'}</td><td style="text-align:center;">1</td><td style="text-align:center;">900.00</td><td>900.00</td></tr>
                </tbody>
            </table>
            
            <div class="totals">
                <div class="total-row"><span>${isRTL ? 'المجموع الفرعي' : 'Subtotal'}</span><span>15,900.00 ${isRTL ? 'ر.س' : 'SAR'}</span></div>
                <div class="total-row"><span>${isRTL ? 'ضريبة القيمة المضافة' : 'VAT'} (15%)</span><span>2,385.00 ${isRTL ? 'ر.س' : 'SAR'}</span></div>
                <div class="total-row grand"><span>${isRTL ? 'الإجمالي' : 'Grand Total'}</span><span>18,285.00 ${isRTL ? 'ر.س' : 'SAR'}</span></div>
            </div>
        </div>
        
        <div class="footer">
            <p>${isRTL ? 'تم اعتماد هذه الفاتورة إلكترونياً من قبل هيئة الزكاة والضريبة والجمارك' : 'This invoice has been electronically approved by ZATCA'}</p>
            <div class="verification">${isRTL ? 'رمز التحقق' : 'Verification'}: ${zatcaId.split('-').pop()}</div>
        </div>
    </div>
    
    <div class="spacer"></div>
    
    <!-- Action Bar -->
    <div class="action-bar">
        <button class="action-btn pdf" onclick="saveToPDF()">
            📄 ${isRTL ? 'حفظ كـ PDF' : 'Save as PDF'}
        </button>
        <a class="action-btn email ${highlightMethod === 'email' ? 'highlight' : ''}" href="mailto:?subject=${emailSubject}&body=${emailBody}">
            ✉️ ${isRTL ? 'إرسال بالبريد' : 'Send Email'}
        </a>
        <a class="action-btn whatsapp ${highlightMethod === 'whatsapp' ? 'highlight' : ''}" href="https://wa.me/?text=${whatsappMsg}" target="_blank">
            💬 ${isRTL ? 'إرسال واتساب' : 'Send WhatsApp'}
        </a>
    </div>
    <script>
        function saveToPDF() {
            if (document.fonts && document.fonts.ready) {
                document.fonts.ready.then(function() { setTimeout(function() { window.print(); }, 200); });
            } else {
                setTimeout(function() { window.print(); }, 800);
            }
        }
    <\/script>
</body>
</html>`;
}


// Download Approved Invoice - opens invoice page with action buttons
document.getElementById('download-btn').addEventListener('click', function() {
    openInvoiceWindow();
});

function resetDemo() {
    // Reset all states
    uploadedFile = null;
    fileInput.value = '';
    
    // Reset upload section
    uploadZone.style.display = 'flex';
    filePreview.classList.remove('show');
    processBtn.disabled = false;
    processBtn.innerHTML = `<i data-lucide="send" class="icon"></i><span class="ar">إرسال للمعالجة</span><span class="en">Send for Processing</span>`;
    
    // Reset cards
    const cards = document.querySelectorAll('.demo-card');
    cards.forEach(card => card.classList.remove('active', 'completed'));
    
    // Reset arrows
    document.querySelectorAll('.flow-arrow').forEach(arrow => arrow.classList.remove('active'));
    
    // Reset statuses
    updateStatus('business', 'waiting', isArabic() ? 'في انتظار الفاتورة' : 'Waiting for invoice');
    updateStatus('ai', 'waiting', isArabic() ? 'في انتظار البيانات' : 'Waiting for data');
    updateStatus('zatca', 'waiting', isArabic() ? 'في الانتظار' : 'Waiting');
    
    // Reset AI section
    document.getElementById('ai-agent').classList.remove('processing');
    updateAIMessage(isArabic() ? 'ارفع فاتورتك وسأقوم بالتحقق منها وإرسالها لزاتكا' : 'Upload your invoice and I\'ll validate it and send to ZATCA');
    document.getElementById('ai-status-text').innerHTML = `<span class="ar">جاهز للمعالجة</span><span class="en">Ready to Process</span>`;
    
    // Reset processing steps
    for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step-${i}`);
        step.classList.remove('active', 'completed');
    }
    
    // Reset ZATCA section
    document.getElementById('zatca-waiting').style.display = 'block';
    document.getElementById('validation-result').classList.remove('show');
    document.getElementById('approved-invoice').classList.remove('show');
    document.getElementById('customer-delivery').classList.remove('show');
    
    // Hide reset section
    document.getElementById('reset-section').style.display = 'none';
    
    lucide.createIcons();
}

// Helper functions
function updateStatus(section, type, text) {
    const badge = document.getElementById(`status-${section}`);
    badge.className = `status-badge ${type}`;
    badge.innerHTML = text;
}

function updateAIMessage(message) {
    document.getElementById('ai-message').textContent = message;
}

function isArabic() {
    return document.getElementById('html-root').getAttribute('lang') === 'ar';
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function generateZATCAId() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let id = 'INV-2026-ZATCA-';
    for (let i = 0; i < 12; i++) {
        id += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return id;
}

function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// Initialize Lucide icons
lucide.createIcons();

// ============================================== //
// ACCOUNTING SECTION FUNCTIONALITY
// ============================================== //

// Data storage for accounting
let accountingData = {
    sales: {
        invoices: [],
        totalSales: 0,
        outputVAT: 0
    },
    expenses: {
        suppliers: [],
        salaries: [],
        rent: [],
        misc: []
    },
    totals: {
        totalExpenses: 0,
        inputVAT: 0
    }
};

// Show accounting section after ZATCA approval
function showAccountingSection() {
    const section = document.getElementById('accounting-section');
    section.style.display = 'block';
    
    // Start with zero invoices - user will upload their own
    accountingData.sales.invoices = [];
    accountingData.sales.totalSales = 0;
    accountingData.sales.outputVAT = 0;
    
    // Clear the invoice list and show empty state
    document.getElementById('invoice-items').innerHTML = `
        <div class="invoice-empty-state" id="invoice-empty-state">
            <i data-lucide="inbox" class="icon icon-xl" style="color:#64748b; margin-bottom:0.5rem;"></i>
            <p style="color:#64748b; font-size:0.85rem;">
                <span class="ar">لا توجد فواتير - ارفع فواتيرك أعلاه</span>
                <span class="en">No invoices yet - upload yours above</span>
            </p>
        </div>
    `;
    
    // Update summary to show zeros
    document.getElementById('total-invoices').textContent = '0';
    document.getElementById('total-sales').textContent = '0';
    document.getElementById('output-vat').textContent = '0';
    document.getElementById('invoice-list-count').textContent = '0';
    
    // Update sales status
    document.getElementById('sales-status').innerHTML = `
        <span class="ar">ارفع الفواتير</span>
        <span class="en">Upload Invoices</span>
    `;
    document.getElementById('sales-status').className = 'status-badge waiting';
    
    // Update reconciliation to show zeros
    document.getElementById('recon-output-vat').textContent = '0';
    document.getElementById('recon-net-vat').textContent = '0';
    
    // Update P&L
    document.getElementById('pnl-revenue').textContent = '0';
    document.getElementById('pnl-profit').textContent = '0';
    document.getElementById('pnl-margin').textContent = '0%';
    
    // Smooth scroll to accounting section
    setTimeout(() => {
        section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 500);
    
    lucide.createIcons();
}

// Toggle expense upload section
function toggleExpenseUpload(category) {
    const catEl = document.getElementById(`cat-${category}`);
    const wasActive = catEl.classList.contains('active');
    
    // Close all others
    document.querySelectorAll('.expense-category').forEach(el => {
        el.classList.remove('active');
    });
    
    // Toggle this one
    if (!wasActive) {
        catEl.classList.add('active');
    }
}

// Trigger file input for expense
function triggerExpenseUpload(category) {
    document.getElementById(`input-${category}`).click();
}

// Handle expense file upload
async function handleExpenseUpload(category, files) {
    if (!files || files.length === 0) return;
    
    for (const file of files) {
        // Show AI processor
        showAIProcessor(isArabic() ? `جاري تحليل ${file.name}...` : `Analyzing ${file.name}...`);
        
        // Simulate AI processing
        await sleep(1500);
        
        // Generate random amount for demo
        const amounts = {
            suppliers: [2500, 3500, 5000, 7500, 10000],
            salaries: [3000, 4000, 4500, 5000, 6000],
            rent: [2000, 3000, 4000, 5000],
            misc: [200, 500, 800, 1000, 1500]
        };
        const amountOptions = amounts[category] || [1000, 2000, 3000];
        const amount = amountOptions[Math.floor(Math.random() * amountOptions.length)];
        
        // Calculate VAT (15% for suppliers and misc, 0 for salaries and rent)
        const vatApplicable = category === 'suppliers' || category === 'misc';
        const vat = vatApplicable ? Math.round(amount * 0.15) : 0;
        
        // Add expense
        addExpenseToCategory(category, file.name, amount, vat);
        
        hideAIProcessor();
    }
    
    // Reset file input
    document.getElementById(`input-${category}`).value = '';
}

// Quick add expense (demo mode)
async function addQuickExpense(category, nameAr, nameEn, amount) {
    const name = isArabic() ? nameAr : nameEn;
    
    // Show AI processor
    showAIProcessor(isArabic() ? `جاري إضافة ${name}...` : `Adding ${name}...`);
    
    await sleep(800);
    
    // Calculate VAT
    const vatApplicable = category === 'suppliers' || category === 'misc';
    const vat = vatApplicable ? Math.round(amount * 0.15) : 0;
    
    addExpenseToCategory(category, name, amount, vat);
    
    hideAIProcessor();
}

// Add expense to category
function addExpenseToCategory(category, name, amount, vat) {
    const expenseId = `exp-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    
    // Add to data
    accountingData.expenses[category].push({
        id: expenseId,
        name: name,
        amount: amount,
        vat: vat
    });
    
    // Update category UI
    const container = document.getElementById(`expenses-${category}`);
    const expenseHTML = `
        <div class="uploaded-expense" id="${expenseId}">
            <i data-lucide="file-check" class="icon icon-sm" style="color:#34d399;"></i>
            <span class="expense-name">${name}</span>
            <span class="expense-amount">${formatNumber(amount)}</span>
            ${vat > 0 ? `<span class="expense-vat">+${formatNumber(vat)} VAT</span>` : ''}
            <button class="remove-expense" onclick="removeExpense('${category}', '${expenseId}')">
                <i data-lucide="x" class="icon icon-sm"></i>
            </button>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', expenseHTML);
    
    // Mark category as having expenses
    document.getElementById(`cat-${category}`).classList.add('has-expenses');
    
    // Update totals
    updateAccountingTotals();
    
    lucide.createIcons();
}

// Remove expense
function removeExpense(category, expenseId) {
    // Remove from data
    accountingData.expenses[category] = accountingData.expenses[category].filter(e => e.id !== expenseId);
    
    // Remove from UI
    document.getElementById(expenseId).remove();
    
    // Check if category is empty
    if (accountingData.expenses[category].length === 0) {
        document.getElementById(`cat-${category}`).classList.remove('has-expenses');
    }
    
    updateAccountingTotals();
}

// Update all accounting totals
function updateAccountingTotals() {
    // Calculate totals per category
    const categories = ['suppliers', 'salaries', 'rent', 'misc'];
    let totalExpenses = 0;
    let totalInputVAT = 0;
    
    categories.forEach(cat => {
        const catTotal = accountingData.expenses[cat].reduce((sum, e) => sum + e.amount, 0);
        const catVAT = accountingData.expenses[cat].reduce((sum, e) => sum + e.vat, 0);
        
        totalExpenses += catTotal;
        totalInputVAT += catVAT;
        
        // Update category amount display
        document.getElementById(`${cat}-amount`).textContent = `${formatNumber(catTotal)} SAR`;
    });
    
    accountingData.totals.totalExpenses = totalExpenses;
    accountingData.totals.inputVAT = totalInputVAT;
    
    // Update expenses status
    const expenseCount = categories.reduce((sum, cat) => sum + accountingData.expenses[cat].length, 0);
    const expensesStatus = document.getElementById('expenses-status');
    if (expenseCount > 0) {
        expensesStatus.className = 'status-badge success';
        expensesStatus.innerHTML = `<i data-lucide="check-circle" class="icon icon-sm"></i> ${expenseCount} ${isArabic() ? 'مصروف' : 'expenses'}`;
    } else {
        expensesStatus.className = 'status-badge waiting';
        expensesStatus.innerHTML = `<span class="ar">أضف المصاريف</span><span class="en">Add Expenses</span>`;
    }
    
    // Update VAT reconciliation
    updateVATReconciliation(totalInputVAT);
    
    // Update P&L
    updateProfitLoss(totalExpenses);
    
    // Update expense breakdown
    updateExpenseBreakdown(totalExpenses);
    
    lucide.createIcons();
}

// Update VAT reconciliation display
function updateVATReconciliation(inputVAT) {
    const outputVAT = accountingData.sales.outputVAT;
    const netVAT = outputVAT - inputVAT;
    
    document.getElementById('recon-output-vat').textContent = formatNumber(outputVAT);
    document.getElementById('recon-input-vat').textContent = formatNumber(inputVAT);
    document.getElementById('recon-net-vat').textContent = formatNumber(Math.abs(netVAT));
    
    const netCard = document.getElementById('vat-net-card');
    const netLabel = document.getElementById('vat-net-label');
    
    if (netVAT < 0) {
        netCard.classList.add('refund');
        netLabel.innerHTML = `<span class="ar">مسترد من الهيئة</span><span class="en">Refundable from ZATCA</span>`;
    } else {
        netCard.classList.remove('refund');
        netLabel.innerHTML = `<span class="ar">مستحق للهيئة</span><span class="en">Payable to ZATCA</span>`;
    }
}

// Update Profit & Loss display
function updateProfitLoss(totalExpenses) {
    const revenue = accountingData.sales.totalSales;
    const profit = revenue - totalExpenses;
    const margin = revenue > 0 ? Math.round((profit / revenue) * 100) : 0;
    
    document.getElementById('pnl-revenue').textContent = formatNumber(revenue);
    document.getElementById('pnl-expenses').textContent = formatNumber(totalExpenses);
    document.getElementById('pnl-profit').textContent = formatNumber(Math.abs(profit));
    document.getElementById('pnl-margin').textContent = `${margin}%`;
    
    const profitItem = document.getElementById('pnl-profit-item');
    const profitLabel = profitItem.querySelector('.pnl-label');
    
    if (profit < 0) {
        profitItem.classList.add('loss');
        profitLabel.innerHTML = `<span class="ar">صافي الخسارة</span><span class="en">Net Loss</span>`;
    } else {
        profitItem.classList.remove('loss');
        profitLabel.innerHTML = `<span class="ar">صافي الربح</span><span class="en">Net Profit</span>`;
    }
}

// Update expense breakdown chart
function updateExpenseBreakdown(totalExpenses) {
    const breakdown = document.getElementById('expense-breakdown');
    
    if (totalExpenses === 0) {
        breakdown.style.display = 'none';
        return;
    }
    
    breakdown.style.display = 'block';
    
    const categories = ['suppliers', 'salaries', 'rent', 'misc'];
    
    categories.forEach(cat => {
        const catTotal = accountingData.expenses[cat].reduce((sum, e) => sum + e.amount, 0);
        const percentage = totalExpenses > 0 ? (catTotal / totalExpenses) * 100 : 0;
        
        const itemEl = document.getElementById(`breakdown-${cat}`);
        const barEl = document.getElementById(`bar-${cat}`);
        const valueEl = document.getElementById(`breakdown-${cat}-value`);
        
        if (catTotal > 0) {
            itemEl.style.display = 'grid';
            barEl.style.width = `${percentage}%`;
            valueEl.textContent = formatNumber(catTotal);
        } else {
            itemEl.style.display = 'none';
        }
    });
}

// Add sample invoice
async function addSampleInvoice() {
    // Remove empty state if present
    const emptyState = document.getElementById('invoice-empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const invoiceNum = accountingData.sales.invoices.length + 1;
    const amounts = [8500, 12000, 6750, 9200, 15000];
    const amount = amounts[Math.floor(Math.random() * amounts.length)];
    const vat = Math.round(amount * 0.15);
    
    const customers = [
        { ar: 'مؤسسة التقنية', en: 'Tech Solutions' },
        { ar: 'شركة البناء', en: 'Construction Co.' },
        { ar: 'مجموعة الخدمات', en: 'Services Group' },
        { ar: 'مؤسسة الأعمال', en: 'Business Corp' }
    ];
    const customer = customers[Math.floor(Math.random() * customers.length)];
    
    const newInvoice = {
        id: `INV-2026-ZATCA-${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
        customer: isArabic() ? customer.ar : customer.en,
        amount: amount,
        vat: vat,
        total: amount + vat
    };
    
    accountingData.sales.invoices.push(newInvoice);
    accountingData.sales.totalSales += amount;
    accountingData.sales.outputVAT += vat;
    
    // Add to UI
    const container = document.getElementById('invoice-items');
    const invoiceHTML = `
        <div class="invoice-item animate-in">
            <div class="invoice-item-icon">
                <i data-lucide="file-check" class="icon"></i>
            </div>
            <div class="invoice-item-details">
                <div class="invoice-item-title">${newInvoice.id}</div>
                <div class="invoice-item-meta">${newInvoice.customer}</div>
            </div>
            <div class="invoice-item-amount">
                <div class="amount">${formatNumber(newInvoice.total)} <small>SAR</small></div>
                <div class="vat-badge">+${formatNumber(newInvoice.vat)} ${isArabic() ? 'ض' : 'VAT'}</div>
            </div>
        </div>
    `;
    container.insertAdjacentHTML('beforeend', invoiceHTML);
    
    // Update summary
    document.getElementById('total-invoices').textContent = accountingData.sales.invoices.length;
    document.getElementById('total-sales').textContent = formatNumber(accountingData.sales.totalSales);
    document.getElementById('output-vat').textContent = formatNumber(accountingData.sales.outputVAT);
    document.getElementById('invoice-list-count').textContent = accountingData.sales.invoices.length;
    
    // Update sales status
    const salesStatus = document.getElementById('sales-status');
    salesStatus.innerHTML = `<i data-lucide="check-circle" class="icon icon-sm"></i> ${accountingData.sales.invoices.length} ${isArabic() ? 'فواتير' : 'Invoices'}`;
    
    // Update reconciliation
    updateVATReconciliation(accountingData.totals.inputVAT);
    updateProfitLoss(accountingData.totals.totalExpenses);
    
    lucide.createIcons();
}

// Show AI processor animation
function showAIProcessor(message) {
    const processor = document.getElementById('ai-expense-processor');
    document.getElementById('processor-text-ar').textContent = message;
    document.getElementById('processor-text-en').textContent = message;
    processor.style.display = 'block';
}

// Hide AI processor
function hideAIProcessor() {
    document.getElementById('ai-expense-processor').style.display = 'none';
}

// Generate Financial Report
function generateFinancialReport() {
    const isRTL = isArabic();
    const date = new Date().toLocaleDateString(isRTL ? 'ar-SA' : 'en-US');
    
    const reportHTML = generateReportHTML('financial', isRTL, date);
    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
}

// Generate VAT Report
function generateVATReport() {
    const isRTL = isArabic();
    const date = new Date().toLocaleDateString(isRTL ? 'ar-SA' : 'en-US');
    
    const reportHTML = generateReportHTML('vat', isRTL, date);
    const reportWindow = window.open('', '_blank');
    reportWindow.document.write(reportHTML);
    reportWindow.document.close();
}

// Generate report HTML
function generateReportHTML(type, isRTL, date) {
    const revenue = accountingData.sales.totalSales;
    const expenses = accountingData.totals.totalExpenses;
    const outputVAT = accountingData.sales.outputVAT;
    const inputVAT = accountingData.totals.inputVAT;
    const netVAT = outputVAT - inputVAT;
    const profit = revenue - expenses;
    const margin = revenue > 0 ? Math.round((profit / revenue) * 100) : 0;
    
    const categories = ['suppliers', 'salaries', 'rent', 'misc'];
    const catNames = {
        suppliers: { ar: 'موردين', en: 'Suppliers' },
        salaries: { ar: 'رواتب', en: 'Salaries' },
        rent: { ar: 'إيجار', en: 'Rent' },
        misc: { ar: 'أخرى', en: 'Miscellaneous' }
    };
    
    let expenseRows = '';
    categories.forEach(cat => {
        const catTotal = accountingData.expenses[cat].reduce((sum, e) => sum + e.amount, 0);
        const catVAT = accountingData.expenses[cat].reduce((sum, e) => sum + e.vat, 0);
        if (catTotal > 0) {
            expenseRows += `
                <tr>
                    <td>${isRTL ? catNames[cat].ar : catNames[cat].en}</td>
                    <td style="text-align:${isRTL ? 'left' : 'right'};">${formatNumber(catTotal)} SAR</td>
                    <td style="text-align:${isRTL ? 'left' : 'right'};">${formatNumber(catVAT)} SAR</td>
                </tr>
            `;
        }
    });
    
    const title = type === 'financial' 
        ? (isRTL ? 'التقرير المالي' : 'Financial Report')
        : (isRTL ? 'تقرير ضريبة القيمة المضافة' : 'VAT Report');
    
    return `<!DOCTYPE html>
<html lang="${isRTL ? 'ar' : 'en'}" dir="${isRTL ? 'rtl' : 'ltr'}">
<head>
    <meta charset="UTF-8">
    <title>${title} - Muhasib</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: '${isRTL ? 'Tajawal' : 'Inter'}', Arial, sans-serif; background: #f1f5f9; min-height: 100vh; padding: 20px; }
        .report { max-width: 800px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; }
        .report-header { background: linear-gradient(135deg, #a78bfa, #818cf8); color: white; padding: 30px; }
        .report-header h1 { font-size: 1.5rem; margin-bottom: 5px; }
        .report-header p { opacity: 0.9; font-size: 0.9rem; }
        .report-content { padding: 30px; }
        .section { margin-bottom: 30px; }
        .section h2 { font-size: 1.1rem; color: #1e293b; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0; }
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px; }
        .summary-item { background: #f8fafc; border-radius: 10px; padding: 15px; border-${isRTL ? 'right' : 'left'}: 4px solid #a78bfa; }
        .summary-item.revenue { border-color: #34d399; }
        .summary-item.expenses { border-color: #fb923c; }
        .summary-item.profit { border-color: #a78bfa; }
        .summary-item.loss { border-color: #f87171; }
        .summary-item .label { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; }
        .summary-item .value { font-size: 1.25rem; font-weight: 700; color: #1e293b; }
        .summary-item.revenue .value { color: #059669; }
        .summary-item.expenses .value { color: #ea580c; }
        .summary-item.profit .value { color: #7c3aed; }
        .summary-item.loss .value { color: #dc2626; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { background: #f1f5f9; padding: 12px; text-align: ${isRTL ? 'right' : 'left'}; font-size: 0.85rem; color: #64748b; border-bottom: 2px solid #e2e8f0; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; font-size: 0.9rem; }
        .vat-summary { display: flex; justify-content: space-between; align-items: center; background: ${netVAT >= 0 ? 'rgba(167,139,250,0.1)' : 'rgba(52,211,153,0.1)'}; border-radius: 12px; padding: 20px; margin-top: 20px; }
        .vat-item { text-align: center; }
        .vat-item .label { font-size: 0.8rem; color: #64748b; margin-bottom: 5px; }
        .vat-item .value { font-size: 1.5rem; font-weight: 700; }
        .vat-item.output .value { color: #059669; }
        .vat-item.input .value { color: #ea580c; }
        .vat-item.net .value { color: ${netVAT >= 0 ? '#7c3aed' : '#059669'}; }
        .operator { font-size: 1.5rem; color: #64748b; }
        .footer { background: #f8fafc; padding: 20px; text-align: center; font-size: 0.8rem; color: #64748b; border-top: 1px solid #e2e8f0; }
        .print-btn { position: fixed; bottom: 20px; right: 20px; background: #a78bfa; color: white; border: none; padding: 15px 25px; border-radius: 10px; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 15px rgba(167,139,250,0.4); }
        .print-btn:hover { background: #8b5cf6; }
        @media print { .print-btn { display: none; } body { background: white; padding: 0; } .report { box-shadow: none; } }
    </style>
</head>
<body>
    <div class="report">
        <div class="report-header">
            <h1>${title}</h1>
            <p>${isRTL ? 'تاريخ التقرير' : 'Report Date'}: ${date}</p>
        </div>
        <div class="report-content">
            ${type === 'financial' ? `
            <div class="section">
                <h2>${isRTL ? 'ملخص الأرباح والخسائر' : 'Profit & Loss Summary'}</h2>
                <div class="summary-grid">
                    <div class="summary-item revenue">
                        <div class="label">${isRTL ? 'إجمالي الإيرادات' : 'Total Revenue'}</div>
                        <div class="value">${formatNumber(revenue)} SAR</div>
                    </div>
                    <div class="summary-item expenses">
                        <div class="label">${isRTL ? 'إجمالي المصاريف' : 'Total Expenses'}</div>
                        <div class="value">${formatNumber(expenses)} SAR</div>
                    </div>
                    <div class="summary-item ${profit >= 0 ? 'profit' : 'loss'}">
                        <div class="label">${profit >= 0 ? (isRTL ? 'صافي الربح' : 'Net Profit') : (isRTL ? 'صافي الخسارة' : 'Net Loss')}</div>
                        <div class="value">${formatNumber(Math.abs(profit))} SAR</div>
                    </div>
                    <div class="summary-item">
                        <div class="label">${isRTL ? 'هامش الربح' : 'Profit Margin'}</div>
                        <div class="value">${margin}%</div>
                    </div>
                </div>
            </div>
            <div class="section">
                <h2>${isRTL ? 'تفصيل المصاريف' : 'Expense Breakdown'}</h2>
                <table>
                    <thead>
                        <tr>
                            <th>${isRTL ? 'الفئة' : 'Category'}</th>
                            <th style="text-align:${isRTL ? 'left' : 'right'};">${isRTL ? 'المبلغ' : 'Amount'}</th>
                            <th style="text-align:${isRTL ? 'left' : 'right'};">${isRTL ? 'الضريبة' : 'VAT'}</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${expenseRows || `<tr><td colspan="3" style="text-align:center;color:#64748b;">${isRTL ? 'لا توجد مصاريف' : 'No expenses'}</td></tr>`}
                    </tbody>
                </table>
            </div>
            ` : ''}
            <div class="section">
                <h2>${isRTL ? 'تسوية ضريبة القيمة المضافة' : 'VAT Reconciliation'}</h2>
                <div class="vat-summary">
                    <div class="vat-item output">
                        <div class="label">${isRTL ? 'ضريبة المخرجات' : 'Output VAT'}</div>
                        <div class="value">${formatNumber(outputVAT)}</div>
                    </div>
                    <div class="operator">−</div>
                    <div class="vat-item input">
                        <div class="label">${isRTL ? 'ضريبة المدخلات' : 'Input VAT'}</div>
                        <div class="value">${formatNumber(inputVAT)}</div>
                    </div>
                    <div class="operator">=</div>
                    <div class="vat-item net">
                        <div class="label">${netVAT >= 0 ? (isRTL ? 'مستحق للهيئة' : 'Payable') : (isRTL ? 'مسترد' : 'Refundable')}</div>
                        <div class="value">${formatNumber(Math.abs(netVAT))}</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <p>${isRTL ? 'تم إنشاء هذا التقرير بواسطة مُحاسِب - محاسبة ذكية بالذكاء الاصطناعي' : 'Generated by Muhasib - AI-Powered Smart Accounting'}</p>
        </div>
    </div>
    <button class="print-btn" onclick="window.print()">📄 ${isRTL ? 'طباعة / حفظ PDF' : 'Print / Save PDF'}</button>
</body>
</html>`;
}

// Helper: Format number with commas
function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// Modify the existing processZATCA to show accounting section
const originalProcessZATCA = processZATCA;
processZATCA = async function() {
    await originalProcessZATCA();
    // Show accounting section after ZATCA approval
    setTimeout(() => {
        showAccountingSection();
    }, 1000);
};

// Modify resetDemo to also reset accounting
const originalResetDemo = resetDemo;
resetDemo = function() {
    originalResetDemo();
    
    // Reset accounting section
    document.getElementById('accounting-section').style.display = 'none';
    
    // Reset accounting data - start with zeros
    accountingData = {
        sales: {
            invoices: [],
            totalSales: 0,
            outputVAT: 0
        },
        expenses: {
            suppliers: [],
            salaries: [],
            rent: [],
            misc: []
        },
        totals: {
            totalExpenses: 0,
            inputVAT: 0
        }
    };
    
    // Reset expense categories
    ['suppliers', 'salaries', 'rent', 'misc'].forEach(cat => {
        document.getElementById(`expenses-${cat}`).innerHTML = '';
        document.getElementById(`${cat}-amount`).textContent = '0 SAR';
        document.getElementById(`cat-${cat}`).classList.remove('has-expenses', 'active');
    });
    
    // Reset invoice list to empty state
    const invoiceItems = document.getElementById('invoice-items');
    invoiceItems.innerHTML = `
        <div class="invoice-empty-state" id="invoice-empty-state">
            <i data-lucide="inbox" class="icon icon-xl" style="color:#64748b; margin-bottom:0.5rem;"></i>
            <p style="color:#64748b; font-size:0.85rem;">
                <span class="ar">لا توجد فواتير - ارفع فواتيرك أعلاه</span>
                <span class="en">No invoices yet - upload yours above</span>
            </p>
        </div>
    `;
    
    // Reset summary cards to zeros
    document.getElementById('total-invoices').textContent = '0';
    document.getElementById('total-sales').textContent = '0';
    document.getElementById('output-vat').textContent = '0';
    document.getElementById('invoice-list-count').textContent = '0';
    
    // Reset reconciliation to zeros
    document.getElementById('recon-output-vat').textContent = '0';
    document.getElementById('recon-input-vat').textContent = '0';
    document.getElementById('recon-net-vat').textContent = '0';
    document.getElementById('vat-net-card').classList.remove('refund');
    
    // Reset P&L to zeros
    document.getElementById('pnl-revenue').textContent = '0';
    document.getElementById('pnl-expenses').textContent = '0';
    document.getElementById('pnl-profit').textContent = '0';
    document.getElementById('pnl-margin').textContent = '0%';
    document.getElementById('pnl-profit-item').classList.remove('loss');
    
    // Reset expense breakdown
    document.getElementById('expense-breakdown').style.display = 'none';
    
    // Reset statuses to waiting
    document.getElementById('sales-status').className = 'status-badge waiting';
    document.getElementById('sales-status').innerHTML = `<span class="ar">ارفع الفواتير</span><span class="en">Upload Invoices</span>`;
    document.getElementById('expenses-status').className = 'status-badge waiting';
    document.getElementById('expenses-status').innerHTML = `<span class="ar">أضف المصاريف</span><span class="en">Add Expenses</span>`;
    
    lucide.createIcons();
};

// ============================================== //
// AI BULK EXPENSE CATEGORIZER FUNCTIONALITY
// ============================================== //

// Bulk upload data storage
let bulkUploadFiles = [];
let categorizationResults = {
    suppliers: [],
    salaries: [],
    rent: [],
    misc: []
};

// DOM Elements for bulk upload
const bulkUploadZone = document.getElementById('bulk-upload-zone');
const bulkFileInput = document.getElementById('bulk-file-input');
const bulkFilesPreview = document.getElementById('bulk-files-preview');
const bulkFilesGrid = document.getElementById('bulk-files-grid');
const bulkFilesCount = document.getElementById('bulk-files-count');
const bulkFilesClear = document.getElementById('bulk-files-clear');
const categorizeBtn = document.getElementById('categorize-btn');
const bulkUploadSection = document.getElementById('bulk-upload-section');

// Click to upload
bulkUploadZone.addEventListener('click', () => {
    bulkFileInput.click();
});

// Drag and drop
bulkUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    bulkUploadZone.classList.add('drag-over');
});

bulkUploadZone.addEventListener('dragleave', () => {
    bulkUploadZone.classList.remove('drag-over');
});

bulkUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    bulkUploadZone.classList.remove('drag-over');
    handleBulkFiles(e.dataTransfer.files);
});

// File input change
bulkFileInput.addEventListener('change', (e) => {
    handleBulkFiles(e.target.files);
});

// Clear all files
bulkFilesClear.addEventListener('click', () => {
    clearBulkUpload();
});

// Handle bulk files
function handleBulkFiles(files) {
    if (!files || files.length === 0) return;
    
    const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
    
    for (const file of files) {
        if (bulkUploadFiles.length >= 20) {
            alert(isArabic() ? 'الحد الأقصى 20 ملف' : 'Maximum 20 files allowed');
            break;
        }
        
        if (!validTypes.includes(file.type)) {
            continue;
        }
        
        if (file.size > 10 * 1024 * 1024) {
            continue;
        }
        
        // Check for duplicates
        if (!bulkUploadFiles.some(f => f.name === file.name && f.size === file.size)) {
            bulkUploadFiles.push(file);
        }
    }
    
    updateBulkFilesPreview();
}

// Update files preview
function updateBulkFilesPreview() {
    if (bulkUploadFiles.length === 0) {
        bulkFilesPreview.classList.remove('show');
        bulkUploadZone.classList.remove('has-files');
        categorizeBtn.disabled = true;
        return;
    }
    
    bulkFilesPreview.classList.add('show');
    bulkUploadZone.classList.add('has-files');
    categorizeBtn.disabled = false;
    
    bulkFilesCount.textContent = bulkUploadFiles.length;
    
    bulkFilesGrid.innerHTML = bulkUploadFiles.map((file, index) => `
        <div class="file-chip" data-index="${index}">
            <i data-lucide="${file.type === 'application/pdf' ? 'file-text' : 'image'}" class="icon file-chip-icon"></i>
            <span class="file-chip-name">${file.name}</span>
            <button class="file-chip-remove" onclick="removeBulkFile(${index})">
                <i data-lucide="x" class="icon icon-sm"></i>
            </button>
        </div>
    `).join('');
    
    lucide.createIcons();
}

// Remove single file
function removeBulkFile(index) {
    bulkUploadFiles.splice(index, 1);
    updateBulkFilesPreview();
}

// Clear all bulk upload
function clearBulkUpload() {
    bulkUploadFiles = [];
    bulkFileInput.value = '';
    updateBulkFilesPreview();
    resetCategorization();
}

// Reset categorization state
function resetCategorization() {
    categorizationResults = { suppliers: [], salaries: [], rent: [], misc: [] };
    
    document.getElementById('ai-categorization-engine').classList.remove('show');
    document.getElementById('categorization-results').classList.remove('show');
    document.getElementById('categorization-success').classList.remove('show');
    
    bulkUploadSection.classList.remove('processing', 'completed');
    
    // Reset categorization steps
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`cat-step-${i}`).classList.remove('active', 'completed');
    }
    
    categorizeBtn.disabled = bulkUploadFiles.length === 0;
    categorizeBtn.innerHTML = `
        <i data-lucide="brain" class="icon icon-lg"></i>
        <span class="ar">تصنيف تلقائي بالذكاء الاصطناعي</span>
        <span class="en">Auto-Categorize with AI</span>
    `;
    categorizeBtn.classList.remove('processing');
    lucide.createIcons();
}

// Categorize button click
categorizeBtn.addEventListener('click', startCategorization);

// Start AI categorization
async function startCategorization() {
    if (bulkUploadFiles.length === 0) return;
    
    // Update UI state
    categorizeBtn.disabled = true;
    categorizeBtn.innerHTML = `<span class="spinner"></span> <span class="ar">جاري التحليل...</span><span class="en">Analyzing...</span>`;
    categorizeBtn.classList.add('processing');
    bulkUploadSection.classList.add('processing');
    
    // Show AI engine
    const aiEngine = document.getElementById('ai-categorization-engine');
    aiEngine.classList.add('show');
    
    // Hide previous results
    document.getElementById('categorization-results').classList.remove('show');
    document.getElementById('categorization-success').classList.remove('show');
    
    // Reset results
    categorizationResults = { suppliers: [], salaries: [], rent: [], misc: [] };
    
    try {
        // Step 1: OCR Reading
        await animateCatStep(1, isArabic() ? 'قراءة محتوى الملفات...' : 'Reading file contents...', 1200);
        
        // Step 2: AI Analysis
        await animateCatStep(2, isArabic() ? 'تحليل الفواتير بالذكاء الاصطناعي...' : 'AI analyzing invoices...', 1500);
        
        // Step 3: Categorizing
        await animateCatStep(3, isArabic() ? 'تصنيف حسب نوع الفاتورة...' : 'Categorizing by invoice type...', 1200);
        
        // Categorize files using simulated AI logic
        categorizeFiles();
        
        // Step 4: Data Extraction
        await animateCatStep(4, isArabic() ? 'استخراج المبالغ والضرائب...' : 'Extracting amounts and taxes...', 1000);
        
        // Show results
        showCategorizationResults();
        
    } catch (error) {
        console.error('Categorization error:', error);
        resetCategorization();
    }
}

// Animate categorization step
async function animateCatStep(stepNum, statusText, delay) {
    const step = document.getElementById(`cat-step-${stepNum}`);
    step.classList.add('active');
    
    // Update status
    document.getElementById('engine-status-detail').innerHTML = statusText;
    
    // Add spinner
    const icon = step.querySelector('.cat-step-icon');
    icon.innerHTML = '<span class="spinner" style="width:18px;height:18px;"></span>';
    
    await sleep(delay);
    
    step.classList.remove('active');
    step.classList.add('completed');
    icon.innerHTML = '<i data-lucide="check" class="icon"></i>';
    lucide.createIcons();
}

// Categorize files using keyword-based simulation
function categorizeFiles() {
    const categoryPatterns = {
        suppliers: {
            keywords: ['supplier', 'vendor', 'مورد', 'توريد', 'materials', 'مواد', 'goods', 'بضائع', 'inventory', 'مخزون', 'purchase', 'شراء', 'building-materials', 'office-supplies', 'it-equipment', 'cleaning-supplies', 'food-wholesale', 'wholesale', 'equipment', 'cleaning', 'food'],
            amounts: [2500, 3500, 4200, 5000, 6500, 7800, 8500, 10000, 12000, 15000]
        },
        salaries: {
            keywords: ['salary', 'payroll', 'راتب', 'رواتب', 'wages', 'أجور', 'employee', 'موظف', 'staff', 'كشف', 'payslip', 'compensation'],
            amounts: [3500, 4000, 4500, 5000, 5500, 6000, 7000, 8000, 9000, 10000]
        },
        rent: {
            keywords: ['rent', 'إيجار', 'lease', 'عقد', 'rent-receipt', 'property', 'عقار', 'rental'],
            amounts: [2500, 3000, 3500, 4000, 4500, 5000, 6000, 8000]
        },
        misc: {
            keywords: ['electricity', 'كهرباء', 'water', 'ماء', 'internet', 'انترنت', 'telecom', 'اتصالات', 'maintenance', 'صيانة', 'utility', 'خدمات', 'misc', 'other', 'أخرى', 'furniture', 'office-furniture', 'invoice-design', 'invoice-electrical', 'invoice-photography', 'invoice-plumbing', 'services', 'professional'],
            amounts: [200, 350, 500, 650, 800, 1000, 1200, 1500, 2000, 2500]
        }
    };
    
    bulkUploadFiles.forEach(file => {
        const fileName = file.name.toLowerCase();
        let category = 'misc'; // Default category
        
        // Check which category the file belongs to
        for (const [cat, patterns] of Object.entries(categoryPatterns)) {
            if (patterns.keywords.some(keyword => fileName.includes(keyword.toLowerCase()))) {
                category = cat;
                break;
            }
        }
        
        // Generate random amount based on category
        const amounts = categoryPatterns[category].amounts;
        const amount = amounts[Math.floor(Math.random() * amounts.length)];
        
        // Calculate VAT (15% for suppliers and misc, 0 for salaries and rent)
        const vatApplicable = category === 'suppliers' || category === 'misc';
        const vat = vatApplicable ? Math.round(amount * 0.15) : 0;
        
        // Add to results
        categorizationResults[category].push({
            id: `bulk-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name: file.name,
            amount: amount,
            vat: vat,
            originalFile: file
        });
    });
}

// Show categorization results
function showCategorizationResults() {
    // Update status
    document.getElementById('engine-status-text').innerHTML = `
        <span class="ar">اكتمل التصنيف!</span>
        <span class="en">Categorization Complete!</span>
    `;
    document.getElementById('engine-status-detail').innerHTML = `
        <span class="ar">تم تصنيف ${bulkUploadFiles.length} فاتورة</span>
        <span class="en">${bulkUploadFiles.length} invoices categorized</span>
    `;
    
    // Build summary tags
    const summaryHTML = [];
    const categories = ['suppliers', 'salaries', 'rent', 'misc'];
    const catLabels = {
        suppliers: { ar: 'موردين', en: 'Suppliers' },
        salaries: { ar: 'رواتب', en: 'Salaries' },
        rent: { ar: 'إيجار', en: 'Rent' },
        misc: { ar: 'أخرى', en: 'Other' }
    };
    
    categories.forEach(cat => {
        const count = categorizationResults[cat].length;
        if (count > 0) {
            summaryHTML.push(`
                <span class="result-tag ${cat}">
                    ${count} <span class="ar">${catLabels[cat].ar}</span><span class="en">${catLabels[cat].en}</span>
                </span>
            `);
        }
    });
    document.getElementById('results-summary').innerHTML = summaryHTML.join('');
    
    // Populate each category
    categories.forEach(cat => {
        const items = categorizationResults[cat];
        const container = document.getElementById(`result-items-${cat}`);
        const countEl = document.getElementById(`result-count-${cat}`);
        const totalEl = document.getElementById(`result-total-${cat}`);
        const categoryEl = document.getElementById(`result-cat-${cat}`);
        
        countEl.textContent = items.length;
        
        if (items.length === 0) {
            categoryEl.classList.add('empty');
            container.innerHTML = '';
            totalEl.textContent = '0 SAR';
        } else {
            categoryEl.classList.remove('empty');
            
            const total = items.reduce((sum, item) => sum + item.amount, 0);
            totalEl.textContent = `${formatNumber(total)} SAR`;
            
            container.innerHTML = items.map(item => `
                <div class="result-cat-item">
                    <i data-lucide="file-check" class="icon icon-sm" style="color:#34d399;"></i>
                    <span class="result-cat-item-name">${item.name}</span>
                    <span class="result-cat-item-amount">${formatNumber(item.amount)}</span>
                    ${item.vat > 0 ? `<span class="result-cat-item-vat">+${formatNumber(item.vat)} VAT</span>` : ''}
                </div>
            `).join('');
        }
    });
    
    // Show results section
    document.getElementById('categorization-results').classList.add('show');
    
    lucide.createIcons();
}

// Apply results button
document.getElementById('apply-results-btn').addEventListener('click', applyCategorizationResults);

// Apply categorization results to expense categories
async function applyCategorizationResults() {
    const applyBtn = document.getElementById('apply-results-btn');
    applyBtn.disabled = true;
    applyBtn.innerHTML = `<span class="spinner"></span> <span class="ar">جاري التطبيق...</span><span class="en">Applying...</span>`;
    
    // Show AI processor
    showAIProcessor(isArabic() ? 'جاري نقل الفواتير إلى الفئات...' : 'Moving invoices to categories...');
    
    await sleep(800);
    
    // Add each categorized expense to its category
    const categories = ['suppliers', 'salaries', 'rent', 'misc'];
    
    for (const cat of categories) {
        for (const item of categorizationResults[cat]) {
            // Add to accounting data
            accountingData.expenses[cat].push({
                id: item.id,
                name: item.name,
                amount: item.amount,
                vat: item.vat
            });
            
            // Add to UI
            const container = document.getElementById(`expenses-${cat}`);
            const expenseHTML = `
                <div class="uploaded-expense" id="${item.id}">
                    <i data-lucide="file-check" class="icon icon-sm" style="color:#34d399;"></i>
                    <span class="expense-name">${item.name}</span>
                    <span class="expense-amount">${formatNumber(item.amount)}</span>
                    ${item.vat > 0 ? `<span class="expense-vat">+${formatNumber(item.vat)} VAT</span>` : ''}
                    <button class="remove-expense" onclick="removeExpense('${cat}', '${item.id}')">
                        <i data-lucide="x" class="icon icon-sm"></i>
                    </button>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', expenseHTML);
            
            // Mark category as having expenses
            document.getElementById(`cat-${cat}`).classList.add('has-expenses');
        }
    }
    
    hideAIProcessor();
    
    // Update all totals
    updateAccountingTotals();
    
    // Show success state
    document.getElementById('categorization-results').classList.remove('show');
    document.getElementById('ai-categorization-engine').classList.remove('show');
    document.getElementById('categorization-success').classList.add('show');
    bulkUploadSection.classList.remove('processing');
    bulkUploadSection.classList.add('completed');
    
    // Update button
    categorizeBtn.innerHTML = `
        <i data-lucide="check-circle" class="icon icon-lg"></i>
        <span class="ar">تم التطبيق بنجاح!</span>
        <span class="en">Applied Successfully!</span>
    `;
    categorizeBtn.style.background = 'linear-gradient(135deg, #34d399, #22d3d1)';
    
    // Clear bulk upload data after a delay
    await sleep(2000);
    
    // Reset for new uploads
    bulkUploadFiles = [];
    bulkFileInput.value = '';
    updateBulkFilesPreview();
    
    await sleep(1000);
    
    // Reset the section for new uploads
    resetCategorization();
    categorizeBtn.style.background = '';
    
    // Scroll to show the updated expense categories
    document.getElementById('cat-suppliers').scrollIntoView({ behavior: 'smooth', block: 'center' });
    
    lucide.createIcons();
}

// Extend resetDemo to also reset bulk upload
const originalResetDemo2 = resetDemo;
resetDemo = function() {
    originalResetDemo2();
    clearBulkUpload();
    clearSalesBulkUpload();
};

// ============================================== //
// BULK SALES INVOICE UPLOAD FUNCTIONALITY
// ============================================== //

// Sales bulk upload data storage
let salesBulkFiles = [];

// DOM Elements for sales bulk upload
const salesUploadZone = document.getElementById('sales-upload-zone');
const salesFileInput = document.getElementById('sales-file-input');
const salesFilesPreview = document.getElementById('sales-files-preview');
const salesFilesList = document.getElementById('sales-files-list');
const salesFilesCount = document.getElementById('sales-files-count');
const salesFilesClear = document.getElementById('sales-files-clear');
const processSalesBtn = document.getElementById('process-sales-btn');

// Click to upload
salesUploadZone.addEventListener('click', () => {
    salesFileInput.click();
});

// Drag and drop
salesUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    salesUploadZone.classList.add('drag-over');
});

salesUploadZone.addEventListener('dragleave', () => {
    salesUploadZone.classList.remove('drag-over');
});

salesUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    salesUploadZone.classList.remove('drag-over');
    handleSalesBulkFiles(e.dataTransfer.files);
});

// File input change
salesFileInput.addEventListener('change', (e) => {
    handleSalesBulkFiles(e.target.files);
});

// Clear all files
salesFilesClear.addEventListener('click', () => {
    clearSalesBulkUpload();
});

// Handle sales bulk files
function handleSalesBulkFiles(files) {
    if (!files || files.length === 0) return;
    
    const validTypes = ['image/jpeg', 'image/png', 'image/jpg', 'application/pdf'];
    
    for (const file of files) {
        if (salesBulkFiles.length >= 10) {
            alert(isArabic() ? 'الحد الأقصى 10 ملفات' : 'Maximum 10 files allowed');
            break;
        }
        
        if (!validTypes.includes(file.type)) continue;
        if (file.size > 10 * 1024 * 1024) continue;
        
        // Check for duplicates
        if (!salesBulkFiles.some(f => f.name === file.name && f.size === file.size)) {
            salesBulkFiles.push(file);
        }
    }
    
    updateSalesFilesPreview();
}

// Update sales files preview
function updateSalesFilesPreview() {
    if (salesBulkFiles.length === 0) {
        salesFilesPreview.classList.remove('show');
        salesUploadZone.classList.remove('has-files');
        processSalesBtn.disabled = true;
        return;
    }
    
    salesFilesPreview.classList.add('show');
    salesUploadZone.classList.add('has-files');
    processSalesBtn.disabled = false;
    
    salesFilesCount.innerHTML = `${salesBulkFiles.length} <span class="ar">ملفات</span><span class="en">files</span>`;
    
    salesFilesList.innerHTML = salesBulkFiles.map((file, index) => `
        <span class="sales-file-tag">
            <i data-lucide="${file.type === 'application/pdf' ? 'file-text' : 'image'}" class="icon icon-sm"></i>
            ${file.name.length > 15 ? file.name.substring(0, 12) + '...' : file.name}
            <button onclick="removeSalesFile(${index})">
                <i data-lucide="x" class="icon icon-sm"></i>
            </button>
        </span>
    `).join('');
    
    lucide.createIcons();
}

// Remove single sales file
function removeSalesFile(index) {
    salesBulkFiles.splice(index, 1);
    updateSalesFilesPreview();
}

// Clear all sales bulk upload
function clearSalesBulkUpload() {
    salesBulkFiles = [];
    salesFileInput.value = '';
    updateSalesFilesPreview();
    processSalesBtn.disabled = true;
    processSalesBtn.innerHTML = `
        <i data-lucide="zap" class="icon"></i>
        <span class="ar">معالجة الفواتير عبر زاتكا</span>
        <span class="en">Process Invoices via ZATCA</span>
    `;
    lucide.createIcons();
}

// Process sales button click
processSalesBtn.addEventListener('click', processBulkSalesInvoices);

// Process bulk sales invoices
async function processBulkSalesInvoices() {
    if (salesBulkFiles.length === 0) return;
    
    processSalesBtn.disabled = true;
    processSalesBtn.innerHTML = `<span class="spinner"></span> <span class="ar">جاري المعالجة...</span><span class="en">Processing...</span>`;
    
    // Show AI processor
    showAIProcessor(isArabic() ? 'جاري معالجة الفواتير عبر زاتكا...' : 'Processing invoices via ZATCA...');
    
    // Remove empty state if present
    const emptyState = document.getElementById('invoice-empty-state');
    if (emptyState) {
        emptyState.remove();
    }
    
    const totalFiles = salesBulkFiles.length;
    
    for (let i = 0; i < totalFiles; i++) {
        const file = salesBulkFiles[i];
        
        // Update processor text
        showAIProcessor(isArabic() 
            ? `جاري معالجة ${i + 1} من ${totalFiles}: ${file.name}` 
            : `Processing ${i + 1} of ${totalFiles}: ${file.name}`);
        
        await sleep(800);
        
        // Generate invoice data
        const amounts = [5500, 7200, 8500, 9800, 11000, 12500, 14000, 15900, 18000, 22000];
        const amount = amounts[Math.floor(Math.random() * amounts.length)];
        const vat = Math.round(amount * 0.15);
        
        const customers = [
            { ar: 'مؤسسة التقنية', en: 'Tech Solutions' },
            { ar: 'شركة البناء', en: 'Construction Co.' },
            { ar: 'مجموعة الخدمات', en: 'Services Group' },
            { ar: 'مؤسسة الأعمال', en: 'Business Corp' },
            { ar: 'شركة الاستشارات', en: 'Consulting Ltd' },
            { ar: 'مصنع المنتجات', en: 'Products Factory' }
        ];
        const customer = customers[Math.floor(Math.random() * customers.length)];
        
        const newInvoice = {
            id: `INV-2026-ZATCA-${Math.random().toString(36).substr(2, 8).toUpperCase()}`,
            customer: isArabic() ? customer.ar : customer.en,
            amount: amount,
            vat: vat,
            total: amount + vat,
            fileName: file.name
        };
        
        // Add to data
        accountingData.sales.invoices.push(newInvoice);
        accountingData.sales.totalSales += amount;
        accountingData.sales.outputVAT += vat;
        
        // Add to UI
        const container = document.getElementById('invoice-items');
        const invoiceHTML = `
            <div class="invoice-item animate-in">
                <div class="invoice-item-icon">
                    <i data-lucide="file-check" class="icon"></i>
                </div>
                <div class="invoice-item-details">
                    <div class="invoice-item-title">${newInvoice.id}</div>
                    <div class="invoice-item-meta">${newInvoice.customer}</div>
                </div>
                <div class="invoice-item-amount">
                    <div class="amount">${formatNumber(newInvoice.total)} <small>SAR</small></div>
                    <div class="vat-badge">+${formatNumber(newInvoice.vat)} ${isArabic() ? 'ض' : 'VAT'}</div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', invoiceHTML);
        lucide.createIcons();
    }
    
    hideAIProcessor();
    
    // Update summary
    document.getElementById('total-invoices').textContent = accountingData.sales.invoices.length;
    document.getElementById('total-sales').textContent = formatNumber(accountingData.sales.totalSales);
    document.getElementById('output-vat').textContent = formatNumber(accountingData.sales.outputVAT);
    document.getElementById('invoice-list-count').textContent = accountingData.sales.invoices.length;
    
    // Update sales status
    const salesStatus = document.getElementById('sales-status');
    salesStatus.innerHTML = `<i data-lucide="check-circle" class="icon icon-sm"></i> ${accountingData.sales.invoices.length} ${isArabic() ? 'فواتير' : 'Invoices'}`;
    
    // Update reconciliation
    updateVATReconciliation(accountingData.totals.inputVAT);
    updateProfitLoss(accountingData.totals.totalExpenses);
    
    // Show success
    processSalesBtn.innerHTML = `
        <i data-lucide="check-circle" class="icon"></i>
        <span class="ar">تم معالجة ${totalFiles} فواتير!</span>
        <span class="en">${totalFiles} invoices processed!</span>
    `;
    
    lucide.createIcons();
    
    // Clear after delay
    await sleep(2000);
    clearSalesBulkUpload();
}
</script>

</body>
</html>
